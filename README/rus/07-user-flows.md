# Пользовательские и административные сценарии (User Flows & Admin Flows)

## Содержание

### Пользовательские сценарии (User Flows)
1. [Регистрация, верификация и вход](#1-регистрация-верификация-и-вход)
2. [Загрузка видео, обработка, просмотр клипов, скачивание/публикация](#2-загрузка-видео-обработка-просмотр-клипов-скачиваниепубликация)
3. [Подключение платформы, публикация клипа, проверка статуса](#3-подключение-платформы-публикация-клипа-проверка-статуса)
4. [Апгрейд тарифного плана через ЮKassa](#4-апгрейд-тарифного-плана-через-юkassa)
5. [Покупка дополнительных минут](#5-покупка-дополнительных-минут)
6. [Добавление BYOK API-ключа](#6-добавление-byok-api-ключа)
7. [Переключение AI-провайдера (RU -- Global)](#7-переключение-ai-провайдера-ru----global)

### Административные сценарии (Admin Flows)
8. [Создание команды, приглашение участников, управление ролями](#8-создание-команды-приглашение-участников-управление-ролями)
9. [Мониторинг использования (аналитика)](#9-мониторинг-использования-аналитика)
10. [Управление подпиской (апгрейд/даунгрейд/отмена)](#10-управление-подпиской-апгрейддаунгрейдотмена)
11. [Подключение платформ для команды](#11-подключение-платформ-для-команды)
12. [Настройка API-ключей для команды](#12-настройка-api-ключей-для-команды)
13. [Серверное администрирование](#13-серверное-администрирование)
14. [Сценарии ошибок и восстановление](#14-сценарии-ошибок-и-восстановление)

---

## Пользовательские сценарии (User Flows)

---

## 1. Регистрация, верификация и вход

### 1.1. Регистрация по email

```
Пользователь                              Система
    |                                         |
    |--- Открывает /register ---------------->|
    |                                         |
    |--- Вводит email + пароль (мин. 8) ----->|
    |--- Нажимает "Зарегистрироваться" ------>|
    |                                         |
    |                                         |--- Zod-валидация входных данных
    |                                         |--- Проверка: email уникален?
    |                                         |    (если занят -- ошибка "Email уже зарегистрирован")
    |                                         |--- bcrypt хэш пароля (salt rounds)
    |                                         |--- Создание User:
    |                                         |      plan_id = 'free'
    |                                         |      minutes_limit = 30
    |                                         |      emailVerified = false
    |                                         |--- Генерация verification token
    |                                         |--- Отправка email со ссылкой подтверждения
    |                                         |
    |<-- "Проверьте почту для подтверждения" --|
    |                                         |
    |--- Открывает email ------               |
    |--- Клик по ссылке /verify-email?token=xxx
    |                                         |--- Проверка token (действует 24ч)
    |                                         |--- emailVerified = true
    |                                         |--- Создание JWT:
    |                                         |      access token (15 мин, HttpOnly)
    |                                         |      refresh token (7 дней, Secure)
    |                                         |
    |<-- Redirect на /dashboard --------------|
    |                                         |
    |--- Видит EmptyState: "Загрузите        |
    |    первое видео"                        |
```

**Ключевые точки:**
- Пароль: минимум 8 символов, хэшируется bcrypt
- Email: обязательная верификация (до подтверждения -- ограниченный функционал)
- Rate limit: 5 попыток регистрации в минуту
- При дублировании email -- ошибка без раскрытия существования аккаунта

### 1.2. Вход через VK OAuth

```
Пользователь              VK                        Система
    |                      |                             |
    |--- Клик "Войти VK" ->|                             |
    |                      |                             |
    |                      |<--- OAuth redirect ---------|
    |                      |     (scope: video, wall)    |
    |                      |                             |
    |--- Авторизация VK -->|                             |
    |--- Разрешить доступ ->|                            |
    |                      |--- Callback + code -------->|
    |                      |                             |--- Exchange code -> access_token
    |                      |                             |--- Получить профиль VK (id, name, photo)
    |                      |                             |--- Найти User по VK ID
    |                      |                             |    или создать нового (plan=free)
    |                      |                             |--- Создать JWT (access + refresh)
    |                      |                             |
    |<-- Redirect /dashboard --|--------------------------|
```

### 1.3. Восстановление пароля

```
Пользователь                              Система
    |                                         |
    |--- /forgot-password -------------------->|
    |--- Вводит email ------------------------>|
    |                                         |--- Проверка: email существует?
    |                                         |    (ответ одинаковый в обоих случаях)
    |                                         |--- Генерация reset token (действует 1 час)
    |                                         |--- Отправка email со ссылкой
    |                                         |
    |<-- "Если email существует, мы отправили ---|
    |     ссылку для сброса"                  |
    |                                         |
    |--- Клик по ссылке /reset-password?token=xxx
    |--- Вводит новый пароль ----------------->|
    |                                         |--- Проверка token (не истёк?)
    |                                         |--- bcrypt хэш нового пароля
    |                                         |--- Обновление пароля в БД
    |                                         |--- Инвалидация старых сессий
    |                                         |
    |<-- Redirect на /login -------------------|
```

---

## 2. Загрузка видео, обработка, просмотр клипов, скачивание/публикация

### 2.1. Полный конвейер (загрузка файла)

```
Пользователь                         Система
    |                                     |
    |--- /dashboard/upload -------------->|
    |                                     |
    |--- Drag & drop MP4 (500 МБ) ------>|
    |                                     |
    |    [ЭТАП 1: Валидация клиентская]   |
    |                                     |--- Проверка MIME-типа (video/mp4)
    |                                     |--- Проверка размера (<= 4 ГБ)
    |                                     |--- Проверка magic bytes (первые 16 байт)
    |                                     |--- Если ошибка -> красное сообщение, СТОП
    |                                     |
    |    [ЭТАП 2: Создание записи]        |
    |                                     |--- tRPC: video.createFromUpload()
    |                                     |    { title, fileName, fileSize }
    |                                     |--- Проверка: достаточно минут на плане?
    |                                     |--- Создание Video (status='uploading')
    |                                     |--- Генерация presigned URL(s) / upload proxy key
    |                                     |
    |    [ЭТАП 3: Загрузка в S3]          |
    |--- XHR PUT /api/upload ------------>|--- (S3 через proxy)
    |                                     |
    |    Прогресс-бар: 0%...25%...50%...  |
    |    Скорость: 3.2 МБ/с              |
    |    Время: ~2 мин                   |
    |    [Отменить] (AbortController)     |
    |                                     |
    |    ...100%                          |
    |                                     |
    |    [ЭТАП 4: Подтверждение]          |
    |                                     |--- tRPC: video.confirmUpload()
    |                                     |--- Video status -> 'transcribing'
    |                                     |--- Добавить задачу в BullMQ: stt queue
    |                                     |
    |<-- Redirect /dashboard/videos/[id] -|
    |                                     |
    |    [ЭТАП 5: Транскрибация]          |
    |--- Видит: "Транскрибация..." ------>|
    |                                     |
    |                   [worker-stt]       |
    |                        |             |
    |                        |--- Скачать аудио из S3
    |                        |--- Whisper API (Cloud.ru или OpenAI)
    |                        |--- -> массив сегментов с таймкодами
    |                        |--- Сохранить Transcript в PostgreSQL
    |                        |--- Video status -> 'analyzing'
    |                        |--- Добавить задачу: llm-analyze queue
    |                                     |
    |    [ЭТАП 6: AI-анализ]              |
    |--- Видит: "AI-анализ..." ---------->|
    |    (обновление в реальном времени    |
    |     через polling)                  |
    |                                     |
    |                   [worker-llm]       |
    |                        |             |
    |                        |--- LLM Router:
    |                        |      selectModel(task, duration, plan, strategy)
    |                        |--- Момент-селекция (Tier 1: T-Pro 2.1)
    |                        |--- Virality scoring (4 компонента x 25)
    |                        |--- Генерация заголовков (Tier 0: GigaChat3-10B)
    |                        |--- CTA suggestions
    |                        |--- Создание Clip записей в PostgreSQL
    |                        |--- Video status -> 'generating_clips'
    |                        |--- Добавить задачи: video-render queue
    |                        |    (по одной на каждый клип, параллельно)
    |                                     |
    |    [ЭТАП 7: Рендеринг клипов]       |
    |--- Видит: "Создание клипов..." ---->|
    |                                     |
    |                   [worker-video]     |
    |                    (параллельно      |
    |                     для каждого      |
    |                     клипа)           |
    |                        |             |
    |                        |--- Скачать исходник из S3
    |                        |--- FFmpeg:
    |                        |      -ss [start] -to [end]
    |                        |      crop ih*9/16:ih (portrait)
    |                        |      scale 1080:1920
    |                        |      subtitles (SRT, стиль)
    |                        |      водяной знак (если Free)
    |                        |      H.264, AAC 128k, faststart
    |                        |--- Загрузить клип в S3
    |                        |--- Clip status -> 'ready'
    |                        |
    |                        |--- Все клипы готовы?
    |                        |--- Video status -> 'completed'
    |                                     |
    |    [ЭТАП 8: Результат]              |
    |--- Видит: "Завершено! 8 клипов" --->|
    |                                     |
    |--- Просматривает клипы (inline      |
    |    видеоплеер)                      |
    |--- Нажимает "Скачать" на клипе ---->|--- Presigned URL / proxy -> скачивание MP4
    |--- Нажимает "Опубликовать" -------->|--- Открывается PublishDialog
```

### 2.2. Загрузка по URL

```
Пользователь                         Система
    |                                     |
    |--- Вкладка "Вставить ссылку" ------>|
    |--- Вводит URL видео --------------->|
    |--- Нажимает "Загрузить" ----------->|
    |                                     |--- Zod-валидация URL
    |                                     |--- tRPC: video.createFromUrl({ url })
    |                                     |--- Создание Video (status='downloading')
    |                                     |--- Добавить задачу: download queue
    |                                     |
    |<-- Redirect /dashboard/videos/[id] -|
    |                                     |
    |                   [worker-download]   |
    |                        |             |
    |                        |--- Скачать видео по URL
    |                        |--- Загрузить в S3
    |                        |--- Video status -> 'transcribing'
    |                        |--- Добавить задачу: stt queue
    |                        |--- (далее как при загрузке файла, ЭТАП 5+)
```

### 2.3. Скачивание клипов

```
Пользователь                         Система
    |                                     |
    |--- Нажимает "Скачать" на клипе ---->|
    |                                     |--- tRPC: clip.download({ clipId })
    |                                     |--- Генерация presigned URL / proxy
    |<-- Загрузка MP4 (H.264, 1080p) ----|
    |                                     |
    |--- (Альтернатива) "Скачать все" -->|
    |                                     |--- Собрать URLs всех клипов (ready)
    |                                     |--- Формирование ZIP-архива
    |<-- Загрузка clips.zip --------------|
```

---

## 3. Подключение платформы, публикация клипа, проверка статуса

### 3.1. Подключение VK (OAuth)

```
Пользователь              VK                        Система
    |                      |                             |
    |--- /settings/platforms                             |
    |--- "Подключить" VK ->|                             |
    |                      |                             |
    |                      |                             |--- tRPC: platform.connect({ platform: 'vk' })
    |                      |                             |--- Генерация OAuth URL
    |                      |<--- Redirect на VK OAuth ---|
    |                      |                             |
    |--- Авторизация VK -->|                             |
    |--- Разрешить доступ ->|                            |
    |                      |--- Callback + code -------->|
    |                      |                             |--- Exchange code -> access_token
    |                      |                             |--- Сохранить PlatformConnection:
    |                      |                             |      platform='vk'
    |                      |                             |      accessToken (зашифрованный)
    |                      |                             |      metadata: { name, devMode }
    |                      |                             |
    |<-- Статус: "Подключено" + имя аккаунта ------------|
```

### 3.2. Подключение Telegram (Token)

```
Пользователь                         Система
    |                                     |
    |--- /settings/platforms ------------>|
    |--- "Подключить" Telegram ---------->|
    |                                     |
    |<-- Раскрытие формы: Bot Token ------|
    |                                     |
    |--- Вводит Bot Token от @BotFather ->|
    |--- (Опционально) Channel ID ------->|
    |--- Нажимает "Подключить" ---------->|
    |                                     |--- tRPC: platform.connect({
    |                                     |      platform: 'telegram',
    |                                     |      token: 'xxx',
    |                                     |      channelId: '@mychannel'
    |                                     |    })
    |                                     |--- Проверка токена через Telegram Bot API
    |                                     |--- Сохранить PlatformConnection
    |                                     |
    |<-- "Подключено" + имя бота ---------|
```

### 3.3. Публикация клипа на несколько платформ

```
Пользователь                         Система
    |                                     |
    |--- На странице видео:               |
    |    Нажимает "Опубликовать" на клипе |
    |                                     |
    |<-- Диалог PublishDialog ------------|
    |                                     |
    |--- [x] VK Клипы                    |
    |--- [x] Rutube                      |
    |--- [x] Telegram                    |
    |--- "Опубликовать сейчас" ---------->|
    |                                     |--- tRPC: publish.publish({
    |                                     |      clipId, platforms: ['vk','rutube','telegram']
    |                                     |    })
    |                                     |--- Создание 3 Publication записей (status='scheduled')
    |                                     |--- 3 задачи в BullMQ publish queue
    |                                     |
    |<-- Диалог закрывается --------------|
    |                                     |
    |    На карточке клипа:               |
    |    VK: [В очереди]                  |
    |    Rutube: [В очереди]              |
    |    TG: [В очереди]                  |
    |                                     |
    |                   [worker-publish]    |
    |                        |             |
    |              (для каждой платформы:) |
    |                        |--- Скачать клип из S3
    |                        |--- Platform API: загрузить видео
    |                        |--- Platform API: опубликовать
    |                        |--- Publication status -> 'published'
    |                        |--- Сохранить platformUrl
    |                        |
    |                   (при ошибке:)      |
    |                        |--- Retry (max 3, exponential backoff)
    |                        |    30 сек -> 1 мин -> 2 мин
    |                        |--- Если все попытки failed:
    |                        |    Publication status -> 'failed'
    |                                     |
    |    (через ~30 сек - 2 мин)          |
    |    VK: [Опубликовано] (ссылка)      |
    |    Rutube: [Опубликовано] (ссылка)  |
    |    TG: [Опубликовано] (ссылка)      |
```

### 3.4. Проверка статуса публикации

```
Пользователь                         Система
    |                                     |
    |--- На карточке клипа видит:         |
    |    VK: [Опубликовано] + ссылка      |--- Кликабельная ссылка на платформу
    |    Rutube: [Ошибка]                 |--- Красный бейдж, можно повторить
    |                                     |
    |--- Нажимает "Опубликовать" снова -->|
    |--- Выбирает только Rutube --------->|
    |--- "Опубликовать сейчас" ---------->|
    |                                     |--- Новая задача в publish queue
    |                                     |--- (retry с новым Publication)
```

**Жизненный цикл статусов публикации:**

```
scheduled --> publishing --> published
                  |
                  +--> (retry 1) --> publishing --> published
                  |                      |
                  +--> (retry 2) -->     +--> (retry 3) --> failed
```

---

## 4. Апгрейд тарифного плана через ЮKassa

### 4.1. Оплата банковской картой

```
Пользователь              ЮKassa                    Система
    |                      |                             |
    |--- /dashboard/billing --------------------------->|
    |                                                   |
    |--- "Перейти на Pro" ----------------------------->|
    |                                                   |
    |<-- CheckoutModal: "Оплата: Pro, 2990₽/мес" ------|
    |                                                   |
    |--- Выбирает: (o) Банковская карта              |
    |--- "Оплатить 2990₽" ----------------------------->|
    |                      |                             |
    |                      |                             |--- tRPC: billing.checkout({
    |                      |                             |      planId: 'pro',
    |                      |                             |      paymentMethod: 'card',
    |                      |                             |      returnUrl: '.../billing?status=success'
    |                      |                             |    })
    |                      |                             |--- ЮKassa API: создать платёж
    |                      |                             |    { amount: 299000 копеек,
    |                      |                             |      payment_method: bank_card,
    |                      |                             |      confirmation: redirect }
    |                      |                             |
    |<-- Redirect на страницу ЮKassa ---|<----------------|
    |                      |                             |
    |--- Вводит данные карты --------->|                 |
    |    (Visa/Mastercard/МИР)        |                 |
    |--- Подтверждает оплату --------->|                 |
    |                      |                             |
    |                      |--- Webhook (payment.succeeded) ->|
    |                      |                             |--- Обновление:
    |                      |                             |      plan_id = 'pro'
    |                      |                             |      minutes_limit = 1000
    |                      |                             |      minutes_used = 0
    |                      |                             |      Subscription:
    |                      |                             |        status = 'active'
    |                      |                             |        currentPeriodEnd = +30 дней
    |                      |                             |        paymentMethod = 'card'
    |                      |                             |
    |<-- Redirect: /billing?status=success --------------|
    |                                                   |
    |--- Видит: "Pro план, 1000 мин, без водяного знака"|
```

### 4.2. Оплата через СБП (QR-код)

```
Пользователь              ЮKassa                    Система
    |                      |                             |
    |--- CheckoutModal --->|                             |
    |--- Выбирает: (o) СБП --------------------------->|
    |--- "Оплатить" ---------------------------------->|
    |                      |                             |
    |                      |                             |--- ЮKassa API: создать СБП-платёж
    |                      |                             |    { confirmation: sbp_qr }
    |                      |                             |--- Получить QR-URL
    |                      |                             |
    |<-- QR-код на экране  |<----------------------------|
    |    "Отсканируйте в   |                             |
    |     приложении банка" |                             |
    |                      |                             |
    |--- Открывает банк -->|                             |
    |--- Сканирует QR ---->|                             |
    |--- Подтверждает ---->|                             |
    |                      |                             |
    |                      |                             |--- Polling каждые 3 сек:
    |                      |                             |    tRPC: billing.checkPaymentStatus()
    |                      |                             |    (макс. 10 минут)
    |                      |                             |
    |                      |--- Webhook (succeeded) ---->|
    |                      |                             |--- Активация плана
    |                      |                             |
    |<-- Redirect /billing?status=success (автоматич.) --|
    |    "Оплата прошла!"  |                             |
```

**Таймауты СБП:**
- Polling: каждые 3 секунды (`refetchInterval: 3000`)
- Максимальное ожидание: 10 минут (`SBP_POLL_TIMEOUT_MS`)
- При таймауте: "Время ожидания истекло. Закройте окно и попробуйте снова."

---

## 5. Покупка дополнительных минут

```
Пользователь                         Система
    |                                     |
    |--- /dashboard/billing             |
    |                                     |
    |    (Осталось < 10 мин)             |
    |    Карточка: "Минуты заканчиваются" |
    |    Осталось 5 мин. 15₽/мин.        |
    |                                     |
    |--- [60 мин -- 900₽] --------------->|
    |                                     |--- tRPC: billing.buyMinutes({
    |                                     |      minutes: 60
    |                                     |    })
    |                                     |--- ЮKassa: создать платёж
    |                                     |    { amount: 90000 копеек }
    |                                     |
    |<-- Redirect на ЮKassa или QR -------|
    |                                     |
    |--- (оплата, как в п.4) ------------>|
    |                                     |--- Webhook (succeeded):
    |                                     |      minutes_limit += 60
    |                                     |      Запись UsageRecord
    |                                     |
    |<-- Минуты добавлены: 65/180 --------|
```

**Варианты покупки:**

| Минуты | Цена (15₽/мин) |
|--------|----------------|
| 30 мин | 450₽ |
| 60 мин | 900₽ |
| 120 мин | 1 800₽ |

---

## 6. Добавление BYOK API-ключа

### 6.1. Полный сценарий

```
Пользователь                    Браузер (Client-side)          Сервер
    |                                |                             |
    |--- /settings/api-keys -------->|                             |
    |                                |                             |
    |    [Условие: Global стратегия активна]                       |
    |    [Если RU -- заглушка "Переключите на Global"]            |
    |                                |                             |
    |    [ЭТАП 1: Разблокировка хранилища]                        |
    |                                |                             |
    |    Хранилище: [x] Заблокировано|                             |
    |                                |                             |
    |--- Вводит пароль хранилища --->|                             |
    |--- Нажимает "Открыть" -------->|                             |
    |                                |--- PBKDF2(пароль, salt, 100K итераций)
    |                                |    -> Master Key (в памяти)
    |                                |--- Попытка расшифровать тестовые данные
    |                                |    из IndexedDB (верификация пароля)
    |                                |
    |    Хранилище: [o] Открыто      |                             |
    |                                |--- Загрузить мета всех ключей из IndexedDB
    |                                |    (provider, keyPreview, createdAt)
    |                                |                             |
    |    [ЭТАП 2: Добавление ключа]                               |
    |                                |                             |
    |--- Находит карточку "Gemini API"                             |
    |--- Статус: [Не подключен]      |                             |
    |                                |                             |
    |--- Вводит API ключ:           |                             |
    |    "AIzaSy..." в поле password |                             |
    |                                |                             |
    |--- Нажимает "Проверить" ------>|                             |
    |                                |--- tRPC: user.testByokKey({  |
    |                                |      provider: 'gemini',    |
    |                                |      apiKey: 'AIzaSy...'    |
    |                                |    }) ---------------------->|
    |                                |                             |
    |                                |                             |--- Proxy запрос к Gemini API
    |                                |                             |--- Тестовый вызов (list models)
    |                                |                             |--- Результат: { valid: true }
    |                                |                             |
    |                                |<-- { valid: true } ---------|
    |                                |                             |
    |                                |--- AES-GCM encrypt(Master Key, 'AIzaSy...')
    |                                |--- Сохранить в IndexedDB:
    |                                |      key: encrypted blob
    |                                |      meta: { provider, keyPreview: 'AIza...****Yz8k',
    |                                |              createdAt: timestamp }
    |                                |                             |
    |<-- "Ключ Gemini подключен"     |                             |
    |    (зелёное сообщение)         |                             |
    |                                |                             |
    |    Карточка: [Подключен]       |                             |
    |    Preview: AIza...****Yz8k    |                             |
    |    Добавлен 27.02.2026         |                             |
    |                                |                             |
    |    [ЭТАП 3: Автоблокировка]                                 |
    |                                |                             |
    |    (30 мин без действий)       |                             |
    |                                |--- onVaultLock:             |
    |                                |    Master Key = null        |
    |                                |    (удалён из памяти)       |
    |                                |                             |
    |    Хранилище: [x] Заблокировано|                             |
    |    (нужно повторно ввести пароль)                            |
```

### 6.2. Использование BYOK-ключа при обработке видео

```
Браузер                              Сервер                  Внешний API
    |                                    |                        |
    |--- Загрузка видео (с Global стр.) ->|                       |
    |                                    |                        |
    |--- Расшифровать Gemini ключ ------>|                       |
    |    из IndexedDB (AES-GCM decrypt) |                        |
    |                                    |                        |
    |--- Отправить ключ в заголовке ---->|                       |
    |    (HTTPS, encrypted transport)   |                        |
    |                                    |--- Использовать ключ   |
    |                                    |    для одного запроса ->|
    |                                    |                        |
    |                                    |<-- Ответ AI API -------|
    |                                    |                        |
    |                                    |--- Удалить ключ из     |
    |                                    |    памяти сервера      |
    |                                    |                        |
    |<-- Результат обработки ------------|                       |
```

**Принцип Zero-Knowledge:** Сервер никогда не хранит API-ключи. Ключ передаётся по HTTPS, используется для одного запроса и немедленно удаляется.

---

## 7. Переключение AI-провайдера (RU -- Global)

```
Пользователь                         Система
    |                                     |
    |--- /dashboard/settings ------------>|
    |                                     |
    |    Текущий: (o) Cloud.ru (Россия)   |
    |             ( ) Global              |
    |                                     |
    |--- Выбирает Global ----------------->|
    |                                     |
    |<-- window.confirm():                |
    |    "При выборе Global стратегии     |
    |     транскрипты будут обрабатываться |
    |     за пределами РФ. Продолжить?"   |
    |                                     |
    |--- "OK" (подтверждает) ------------>|
    |                                     |--- tRPC: user.updateSettings({
    |                                     |      llmProviderPreference: 'global'
    |                                     |    })
    |                                     |--- Обновление user.llmProviderPreference
    |                                     |
    |    Текущий: ( ) Cloud.ru            |
    |             (o) Global              |
    |                                     |
    |    Секция BYOK: "Используйте свои  |
    |    API ключи для экономии"          |
    |    [Управление ключами] (активна)   |
    |                                     |
    |--- (При следующей загрузке видео)   |
    |                                     |--- LLM Router использует Global модели:
    |                                     |      Tier 0: Gemini Flash Lite
    |                                     |      Tier 1: Gemini 2.0 Flash
    |                                     |      Tier 2: Claude Haiku 4.5
    |                                     |      Tier 3: Gemini 2.5 Pro
    |                                     |      STT: OpenAI Whisper
```

**Обратное переключение (Global -> RU):**
- Без предупреждения (данные остаются в РФ)
- BYOK-ключи остаются в IndexedDB, но не используются
- Кнопка "Управление ключами" становится неактивной

---

## Административные сценарии (Admin Flows)

---

## 8. Создание команды, приглашение участников, управление ролями

### 8.1. Создание команды

```
Владелец                               Система
    |                                     |
    |--- /dashboard/team ----------------->|
    |                                     |
    |    Состояние: "Нет команды"         |
    |    (Доступно на Pro и Business)      |
    |                                     |
    |--- CreateTeamForm:                  |
    |    Название: "Маркетинг Про" ------>|
    |--- "Создать" ---------------------->|
    |                                     |--- Проверка: план поддерживает команду?
    |                                     |    (Pro: max 3, Business: max 10)
    |                                     |--- tRPC: team.create({ name: 'Маркетинг Про' })
    |                                     |--- Создать Team в PostgreSQL
    |                                     |--- Создать TeamMember:
    |                                     |      userId = текущий пользователь
    |                                     |      role = 'owner'
    |                                     |
    |<-- Команда создана! "Маркетинг Про" |
    |    Участников: 1                    |
```

### 8.2. Приглашение участника

```
Владелец/Админ                       Система                    Участник
    |                                     |                         |
    |--- InviteMemberForm:                |                         |
    |    Email: user2@example.com         |                         |
    |    Роль: [Участник v]               |                         |
    |    "Пригласить" ------------------->|                         |
    |                                     |--- Проверка: лимит команды не превышен?
    |                                     |--- tRPC: team.invite({
    |                                     |      email: 'user2@example.com',
    |                                     |      role: 'member'
    |                                     |    })
    |                                     |--- Создать TeamInvite (status='pending')
    |                                     |--- Генерация invite token
    |                                     |--- Отправка email:
    |                                     |    "Вас приглашают в команду 'Маркетинг Про'"
    |                                     |    Ссылка: /invite?token=xxx -------->|
    |                                     |                                      |
    |<-- "Приглашение отправлено" --------|                                      |
    |                                     |                                      |
    |    MemberList:                       |                                      |
    |    Ожидающие: user2@... [Отменить]  |                                      |
    |                                     |                         |
    |                                     |         Участник:       |
    |                                     |         |               |
    |                                     |<-- Клик ссылке в email  |
    |                                     |    /invite?token=xxx    |
    |                                     |                         |
    |                                     |--- Проверить token      |
    |                                     |--- Пользователь          |
    |                                     |    зарегистрирован?      |
    |                                     |    Да -> Создать         |
    |                                     |          TeamMember      |
    |                                     |          (role='member') |
    |                                     |    Нет -> Redirect       |
    |                                     |           /register      |
    |                                     |           (с invite      |
    |                                     |            token)        |
    |                                     |                         |
    |                                     |<-- Redirect /dashboard  |
    |                                     |                         |
    |    MemberList:                       |                         |
    |    user2@... | Участник | [Удалить] |                         |
```

### 8.3. Управление ролями

```
Владелец                               Система
    |                                     |
    |--- MemberList:                      |
    |    user2@... | Участник | [Удалить] |
    |                                     |
    |--- Нажимает [Удалить] на user2 ---->|
    |                                     |--- tRPC: team.removeMember({ userId })
    |                                     |--- Удалить TeamMember из PostgreSQL
    |                                     |--- user2 теряет доступ к видео команды
    |                                     |
    |<-- Обновлённый список участников ---|
```

**Матрица прав:**

```
+-------------------+---------+-------+--------+
| Действие          | Owner   | Admin | Member |
+-------------------+---------+-------+--------+
| Создать команду   | Да      | --    | --     |
| Удалить команду   | Да      | --    | --     |
| Пригласить        | Да      | Да    | --     |
| Удалить участника | Да      | Да    | --     |
| Покинуть команду  | --      | Да    | Да     |
| Загружать видео   | Да      | Да    | Да     |
| Скачивать клипы   | Да      | Да    | Да     |
| Публиковать       | Да      | Да    | Да     |
| Управлять биллингом| Да     | --    | --     |
+-------------------+---------+-------+--------+
```

---

## 9. Мониторинг использования (аналитика)

```
Пользователь/Админ                   Система
    |                                     |
    |--- /dashboard/analytics ----------->|
    |                                     |
    |                                     |--- Параллельные tRPC-запросы:
    |                                     |    analytics.overview()
    |                                     |    analytics.byPlatform()
    |                                     |    analytics.topClips({ limit: 10 })
    |                                     |    analytics.timeline({ days: 30 })
    |                                     |
    |<-- Loading Skeleton (пульсация) ----|
    |                                     |
    |<-- Данные загружены:                |
    |                                     |
    |    OverviewCards:                    |
    |    [Просмотры: 12,450]              |
    |    [Лайки: 890]                     |
    |    [Репосты: 234]                   |
    |    [Клипов: 42]                     |
    |                                     |
    |    PlatformTable:                   |
    |    VK:     8,200 просм. | 560 лайк. |
    |    Rutube: 2,100        | 180       |
    |    Дзен:   1,500        | 100       |
    |    TG:     650          | 50        |
    |                                     |
    |    TopClipsTable:                   |
    |    #1 "5 способов продаж" 3,200     |
    |    #2 "Ошибки маркетинга" 2,100    |
    |                                     |
    |    TimelineChart:                   |
    |    [линейный график за 30 дней]     |
    |                                     |
    |--- Меняет период: [7 дн] ---------->|
    |                                     |--- analytics.timeline({ days: 7 })
    |<-- Обновлённый график --------------|
    |                                     |
    |--- Нажимает [Обновить] ------------>|
    |                                     |--- utils.analytics.invalidate()
    |                                     |--- Перезапрос всех 4 эндпоинтов
    |<-- Свежие данные -------------------|
```

**Обновление статистики:** Данные с платформ собираются worker `stats-collector.ts` каждые 6 часов. Последние публикации могут не иметь статистики.

---

## 10. Управление подпиской (апгрейд/даунгрейд/отмена)

### 10.1. Отмена подписки

```
Пользователь                         Система
    |                                     |
    |--- /dashboard/billing             |
    |                                     |
    |    SubscriptionCard:                |
    |    Тариф: Pro | Активна             |
    |    Следующее списание: 15.04.2026   |
    |                                     |
    |--- "Отменить подписку" ------------>|
    |                                     |
    |<-- window.confirm():                |
    |    "Ваш план будет активен до       |
    |     15.04.2026. Подтвердить отмену?"|
    |                                     |
    |--- "OK" (подтверждает) ------------>|
    |                                     |--- tRPC: billing.cancel()
    |                                     |--- Subscription:
    |                                     |      cancelAtPeriodEnd = true
    |                                     |      (план остаётся до конца периода)
    |                                     |
    |    SubscriptionCard:                |
    |    Тариф: Pro                       |
    |    "Активна до 15.04.2026"          |
    |    [Возобновить подписку]            |
    |                                     |
    |--- (После 15.04.2026)             |
    |                                     |--- billing-cron worker:
    |                                     |      plan_id = 'free'
    |                                     |      minutes_limit = 30
    |                                     |      Subscription status = 'expired'
```

### 10.2. Возобновление подписки

```
Пользователь                         Система
    |                                     |
    |    SubscriptionCard:                |
    |    "Активна до 15.04.2026"          |
    |    [Возобновить подписку]            |
    |                                     |
    |--- "Возобновить подписку" --------->|
    |                                     |--- tRPC: billing.reactivate()
    |                                     |--- Subscription:
    |                                     |      cancelAtPeriodEnd = false
    |                                     |
    |    SubscriptionCard:                |
    |    Тариф: Pro | Активна             |
    |    Следующее списание: 15.04.2026   |
    |    [Отменить подписку]              |
```

---

## 11. Подключение платформ для команды

```
Владелец/Админ                       Система
    |                                     |
    |--- /settings/platforms ------------>|
    |                                     |
    |    (Платформы привязаны к аккаунту  |
    |     владельца, не к команде)        |
    |                                     |
    |--- Подключить VK (OAuth) ---------->|
    |--- Подключить Rutube (token) ------>|
    |--- Подключить Telegram (token) ---->|
    |                                     |
    |    Все участники команды могут      |
    |    публиковать клипы через          |
    |    подключённые платформы            |
    |                                     |
    |--- Проверить подключение:           |
    |    [Проверить] на карточке VK ----->|
    |                                     |--- platform.testConnection({ platform: 'vk' })
    |                                     |--- Тестовый API-вызов
    |<-- "Подключение активно (Иван)" ---|
```

---

## 12. Настройка API-ключей для команды

```
Владелец                               Система
    |                                     |
    |--- /settings/api-keys            |
    |                                     |
    |    Примечание: BYOK-ключи хранятся  |
    |    в браузере КОНКРЕТНОГО пользователя. |
    |    Каждый участник команды должен     |
    |    добавить свои ключи самостоятельно.|
    |                                     |
    |    Владелец:                        |
    |    - Переключает стратегию на Global|
    |      (влияет на всю команду)        |
    |    - Добавляет свои BYOK-ключи      |
    |    - Инструктирует участников       |
    |                                     |
    |    Участник:                        |
    |    - Видит Global стратегию         |
    |    - Добавляет свои ключи через     |
    |      /settings/api-keys             |
    |    - Ключи шифруются в ЕГО браузере |
    |    - При обработке видео            |
    |      используются ЕГО ключи        |
```

**Важно:** BYOK-ключи -- это свойство отдельного пользователя, не команды. Каждый участник управляет своими ключами независимо. AI-стратегия (RU/Global) задаётся владельцем и применяется ко всем.

---

## 13. Серверное администрирование

### 13.1. Первоначальное развёртывание

```
Администратор                                  VPS
    |                                            |
    |--- SSH подключение ----------------------->|
    |--- apt install docker-ce docker-compose -->|
    |--- git clone ... /opt/clipmaker ---------->|
    |                                            |
    |--- Настройка .env:                        |
    |    DATABASE_URL=postgresql://...           |
    |    REDIS_URL=redis://...                   |
    |    NEXTAUTH_SECRET=$(openssl rand -hex 32) |
    |    CLOUDRU_API_KEY=xxx                     |
    |    S3_ACCESS_KEY / S3_SECRET_KEY           |
    |    YOOKASSA_SHOP_ID / YOOKASSA_SECRET_KEY  |
    |                                            |
    |--- docker compose up -d --build ---------->|
    |    (сборка ~2-5 мин)                      |
    |                                            |
    |--- npx prisma migrate deploy ------------>|
    |--- certbot --nginx -d clipmaker.ru ------->|
    |--- curl https://clipmaker.ru --------------->|
    |<-- HTTP/2 200 ----------------------------|
```

### 13.2. Ежедневный мониторинг

```
Администратор                                  VPS
    |                                            |
    |--- docker compose ps --------------------->|
    |<-- Все контейнеры UP (healthy) ------------|
    |                                            |
    |--- docker stats --no-stream -------------->|
    |<-- CPU: 15%, RAM: 4.2/8 GB, Disk: 55% ----|
    |                                            |
    |--- Проверка очередей BullMQ:              |
    |    redis-cli LLEN bull:stt:wait          |
    |    redis-cli LLEN bull:video-render:wait  |
    |    redis-cli ZCARD bull:publish:failed    |
    |<-- Очереди пусты (всё обработано) ---------|
    |                                            |
    |--- Проверка failed видео:                 |
    |    SELECT count(*) FROM videos            |
    |    WHERE status='failed'                  |
    |    AND created_at > now() - '24h'         |
    |<-- 0 (нет ошибок) ------------------------|
    |                                            |
    |--- Проверка бэкапов:                      |
    |    ls -la /opt/clipmaker/backups/          |
    |<-- clipmaker_20260227_030000.sql.gz -------|
```

### 13.3. Обновление системы

```
Администратор                                  VPS
    |                                            |
    |--- git pull origin main ------------------>|
    |<-- 5 новых коммитов ----------------------|
    |                                            |
    |--- docker compose -f docker-compose.prod.yml |
    |    up -d --build ------------------------->|
    |    (пересборка ~2-3 мин)                  |
    |                                            |
    |--- npx prisma migrate deploy ------------->|
    |<-- Миграции применены ---------------------|
    |                                            |
    |--- docker compose ps --------------------->|
    |<-- Все контейнеры UP ----------------------|
    |                                            |
    |--- curl -I https://clipmaker.ru ------------>|
    |<-- HTTP/2 200 ----------------------------|
```

### 13.4. Ручное управление пользователями (через БД)

```
Администратор                                  PostgreSQL
    |                                            |
    |--- psql -U clipmaker clipmaker ------------>|
    |                                            |
    |--- SELECT id, email, plan_id, minutes_used |
    |    FROM users WHERE email = 'vip@client.ru'|
    |<-- id: abc-123, plan: free, used: 25 ------|
    |                                            |
    |--- UPDATE users SET                        |
    |    plan_id = 'pro',                        |
    |    minutes_limit = 1000,                   |
    |    minutes_used = 0                        |
    |    WHERE email = 'vip@client.ru'; -------->|
    |<-- UPDATE 1 -------------------------------|
```

---

## 14. Сценарии ошибок и восстановление

### 14.1. Видео зависло в обработке

```
Пользователь                         Система
    |                                     |
    |--- Видео > 10 мин в статусе         |
    |    "transcribing" ----------------->|
    |                                     |
    |   Возможные причины:                |
    |   - Cloud.ru / Whisper API timeout  |
    |   - worker-stt упал / перезагрузка  |
    |   - Redis переполнен               |
    |   - Сетевая ошибка                 |
    |                                     |
    |   Автоматическое восстановление:    |
    |   - BullMQ retry (3 попытки,        |
    |     exponential backoff)            |
    |   - При рестарте воркер подберёт    |
    |     незавершённые задачи            |
    |                                     |
    |   Ручное восстановление:            |
    |   Администратор:                    |
    |   1. docker compose logs worker-stt |
    |   2. redis-cli LLEN bull:stt:active |
    |   3. docker compose restart worker  |
```

### 14.2. Ошибка публикации

```
Пользователь                         Система
    |                                     |
    |    Публикация VK -> "Ошибка"        |
    |                                     |
    |   Автоматический retry:             |
    |                                     |
    |   Попытка 1: немедленно --> fail    |
    |   Попытка 2: +30 сек ----> fail     |
    |   Попытка 3: +2 мин -----> fail     |
    |                                     |
    |   Publication status -> 'failed'    |
    |                                     |
    |   Возможные причины:                |
    |   - Токен VK истёк                  |
    |   - Rate limit VK API (429)         |
    |   - VK API downtime                |
    |   - Файл клипа повреждён           |
    |                                     |
    |   Решение пользователя:             |
    |   1. Переподключить VK:             |
    |      /settings/platforms            |
    |      [Проверить] -> "Токен невалиден"|
    |      [Отключить] -> [Подключить]    |
    |   2. Повторить публикацию:          |
    |      [Опубликовать] -> VK           |
```

### 14.3. Недостаточно минут

```
Пользователь                         Система
    |                                     |
    |--- Загружает 60-мин видео --------->|
    |--- Осталось: 5 минут (Free) ------->|
    |                                     |
    |<-- Ошибка: "Недостаточно минут.     |
    |     Перейдите на платный план или    |
    |     докупите минуты." --------------|
    |                                     |
    |--- Вариант A: апгрейд плана ------->|
    |    /dashboard/billing               |
    |    "Перейти на Start" (120 мин)     |
    |                                     |
    |--- Вариант B: покупка минут -------->|
    |    /dashboard/billing               |
    |    [60 мин -- 900₽]                 |
    |                                     |
    |--- Вариант C: загрузить короче ---->|
    |    (видео <= 5 мин)                |
```

### 14.4. Ошибка оплаты

```
Пользователь              ЮKassa                    Система
    |                      |                             |
    |--- Оплата Start ---->|                             |
    |--- Вводит карту ---->|                             |
    |                      |--- payment.canceled ------->|
    |                      |                             |--- Подписка НЕ создана
    |                      |                             |--- План остаётся Free
    |                      |                             |
    |<-- Redirect /billing (без ?status=success) --------|
    |                                                    |
    |    (Или: "Оплата не прошла")                      |
    |                                                    |
    |--- Повторить: другая карта или СБП              |
```

### 14.5. Просроченная подписка

```
    [billing-cron worker: каждые 1ч]
    |
    |--- Проверка: subscription.currentPeriodEnd < now()?
    |
    |--- Если cancelAtPeriodEnd = true:
    |      plan_id -> 'free'
    |      minutes_limit -> 30
    |      minutes_used -> 0
    |      subscription.status -> 'expired'
    |
    |--- Если auto-renewal:
    |      Попытка списания через ЮKassa
    |      Успех -> currentPeriodEnd += 30 дней, minutes_used = 0
    |      Fail -> subscription.status = 'past_due'
    |              Отправка email: "Проблема с оплатой"
```

### 14.6. BYOK-ключ недействителен

```
Пользователь                    Браузер                    Сервер
    |                                |                         |
    |--- Вводит невалидный ключ ---->|                         |
    |--- "Проверить" --------------->|                         |
    |                                |--- testByokKey() ------>|
    |                                |                         |--- Proxy к Gemini API
    |                                |                         |--- 401 Unauthorized
    |                                |                         |
    |                                |<-- { valid: false,      |
    |                                |     error: "Invalid..." }|
    |                                |                         |
    |                                |--- НЕ сохраняет в IndexedDB
    |                                |                         |
    |<-- "Key validation failed"     |                         |
    |    (красное сообщение)         |                         |
    |                                |                         |
    |--- Исправляет ключ ----------->|                         |
    |--- "Проверить" снова --------->|                         |
```

### 14.7. Хранилище ключей недоступно

```
Пользователь                    Браузер
    |                                |
    |--- /settings/api-keys -------->|
    |                                |--- isVaultAvailable() -> false
    |                                |    (нет Web Crypto API или IndexedDB)
    |                                |
    |<-- Жёлтый баннер:              |
    |    "Хранилище ключей недоступно |
    |     в этом браузере. Убедитесь, |
    |     что используете HTTPS и     |
    |     современный браузер."       |
```

**Причины:** HTTP (не HTTPS), устаревший браузер, private/incognito режим (IndexedDB ограничен), корпоративные политики безопасности.

---

## 🔄 Отличия Dev и Prod сред

Пользовательские и административные сценарии могут существенно различаться в зависимости от среды выполнения. Ниже описаны ключевые отличия в поведении потоков (flows).

### Регистрация и верификация

| Шаг | Dev | Prod |
|-----|-----|------|
| **Ввод email и пароля** | Одинаково | Одинаково |
| **Отправка email верификации** | Email НЕ отправляется. В логах -- Ethereal preview URL | Реальное письмо на почту пользователя |
| **Верификация email** | Автоматическая (`NODE_ENV === 'development'`). Аккаунт активен сразу | Пользователь должен перейти по ссылке из письма |
| **Переход в дашборд** | Мгновенный после регистрации | Только после подтверждения email |

```
Dev:   Регистрация → Авто-верификация → Дашборд (мгновенно)
Prod:  Регистрация → Email со ссылкой → Клик по ссылке → Дашборд
```

### OAuth подключение платформ

| Шаг | Dev | Prod |
|-----|-----|------|
| **Нажатие "Подключить VK"** | Симулированное подключение (без redirect) | Redirect на VK OAuth (авторизация в VK) |
| **Получение токена** | Фиктивный токен (dev-заглушка) | Реальный access_token от VK |
| **Бейдж на карточке** | "Подключено" + `(dev)` | "Подключено" + имя реального аккаунта |
| **Публикация клипа** | Не пройдёт (фиктивный токен) | Реальная загрузка на платформу |

```
Dev:   "Подключить VK" → Мгновенное "Подключено (dev)" → Публикация: ошибка
Prod:  "Подключить VK" → VK OAuth → Авторизация → Callback → Реальная публикация
```

Аналогичная логика для Дзен (OAuth). Для Rutube и Telegram (ввод токена) -- работает одинаково в обеих средах, но публикация требует реальных токенов.

### Оплата и биллинг

| Шаг | Dev | Prod |
|-----|-----|------|
| **Выбор плана** | UI работает | UI работает |
| **Нажатие "Оплатить"** | Ошибка (ЮKassa не настроена без `YOOKASSA_SHOP_ID`) | Redirect на страницу оплаты ЮKassa |
| **Webhook от ЮKassa** | Не вызывается | Автоматическое обновление подписки |
| **Тестирование плана** | Ручное: `UPDATE users SET plan_id = 'pro' ...` через SQL | Через UI после успешной оплаты |

```
Dev:   "Оплатить" → Ошибка (ЮKassa не настроена) → Ручной SQL для тестирования
Prod:  "Оплатить" → ЮKassa → Оплата → Webhook → Подписка активна
```

### Email-уведомления (все потоки)

| Поток | Dev | Prod |
|-------|-----|------|
| **Верификация email** | Авто-верификация (email не отправляется) | Письмо с ссылкой подтверждения |
| **Сброс пароля** | Ethereal preview URL в логах | Письмо со ссылкой сброса на реальную почту |
| **Приглашение в команду** | Ссылка-приглашение в UI + Ethereal | Письмо с ссылкой-приглашением |
| **Проблема с оплатой** | `console.log` в worker | SMTP-письмо пользователю |
| **Просмотр писем** | `docker compose logs web \| grep "ethereal"` | Почтовый ящик пользователя |

### Сводная таблица отличий в потоках

| Поток (Flow) | Dev | Prod |
|-------------|-----|------|
| **Регистрация** | Авто-верификация, мгновенный доступ | Верификация по email обязательна |
| **OAuth (VK, Дзен)** | Симулированное подключение с `(dev)` бейджем | Реальный OAuth 2.0 с redirect |
| **Публикация клипов** | Не работает (фиктивные токены платформ) | Реальная публикация на VK/Rutube/Дзен/TG |
| **Оплата** | Не функциональна (ЮKassa не настроена) | Карта / СБП через ЮKassa |
| **Email-уведомления** | Ethereal (preview URL в логах) | Реальная доставка на почту |
| **Доступ к видеофайлам** | Proxy через API (MinIO) | Presigned URLs (S3) |
| **Сброс пароля** | Ссылка в Ethereal preview | Ссылка в реальном email |
| **Приглашение в команду** | Ссылка отображается в UI | Ссылка отправляется по email |
