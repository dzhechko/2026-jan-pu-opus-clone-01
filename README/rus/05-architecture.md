# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã –ö–ª–∏–ø–ú–µ–π–∫–µ—Ä

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å](#1-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π-—Å—Ç–∏–ª—å)
2. [–í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#2-–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è](#3-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è)
4. [Web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Next.js)](#4-web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ-nextjs)
5. [API-—Å–ª–æ–π (tRPC)](#5-api-—Å–ª–æ–π-trpc)
6. [–§–æ–Ω–æ–≤—ã–µ –≤–æ—Ä–∫–µ—Ä—ã (BullMQ)](#6-—Ñ–æ–Ω–æ–≤—ã–µ-–≤–æ—Ä–∫–µ—Ä—ã-bullmq)
7. [LLM Router](#7-llm-router)
8. [–ö–æ–Ω–≤–µ–π–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ](#8-–∫–æ–Ω–≤–µ–π–µ—Ä-–æ–±—Ä–∞–±–æ—Ç–∫–∏-–≤–∏–¥–µ–æ)
9. [–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ-–ø–æ—Å—Ç–∏–Ω–≥–∞](#9-—Å–∏—Å—Ç–µ–º–∞-–∞–≤—Ç–æ-–ø–æ—Å—Ç–∏–Ω–≥–∞)
10. [–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö](#10-–º–æ–¥–µ–ª—å-–¥–∞–Ω–Ω—ã—Ö)
11. [–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#11-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è-–∏-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
12. [–ë–∏–ª–ª–∏–Ω–≥ –∏ –ø–ª–∞—Ç–µ–∂–∏](#12-–±–∏–ª–ª–∏–Ω–≥-–∏-–ø–ª–∞—Ç–µ–∂–∏)
13. [–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API-–∫–ª—é—á–µ–π (BYOK)](#13-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ-api-–∫–ª—é—á–µ–π-byok)

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å

–ö–ª–∏–ø–ú–µ–π–∫–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω **Distributed Monolith** –≤ **Monorepo**:

- –í–µ—Å—å –∫–æ–¥ –≤ –æ–¥–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (Turborepo)
- –°–µ—Ä–≤–∏—Å—ã –¥–µ–ª—è—Ç –æ–±—â—É—é –∫–æ–¥–æ–≤—É—é –±–∞–∑—É, –Ω–æ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ –æ–±—â—É—é PostgreSQL –∏ Redis-–æ—á–µ—Ä–µ–¥—å (–±–µ–∑ HTTP –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏)
- –û–±—â–∏–µ —Ç–∏–ø—ã –∏ —É—Ç–∏–ª–∏—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `packages/`

**–ü–æ—á–µ–º—É –Ω–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã:**
- –ö–æ–º–∞–Ω–¥–∞ –∏–∑ 1-2 —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ -- –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –∏–∑–±—ã—Ç–æ—á–Ω—ã
- –û–±—â–∞—è –ë–î –∏ —Ç–∏–ø—ã –ø—Ä–æ—â–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ
- Docker Compose –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –¥–µ–ø–ª–æ—è (–±–µ–∑ Kubernetes)
- –ü—Ä–∏ —Ä–æ—Å—Ç–µ –≤–æ—Ä–∫–µ—Ä—ã –ª–µ–≥–∫–æ –≤—ã–Ω–µ—Å—Ç–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã

---

## 2. –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
+------------------+       +-------------------+
|    –ë—Ä–∞—É–∑–µ—Ä       |       |   VK / Rutube /   |
|                  |       |   –î–∑–µ–Ω / Telegram  |
|  Next.js SPA     |       |   (–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)     |
|  Encrypted Vault |       +--------^----------+
+--------+---------+                |
         |                          |
         | HTTPS                    |
         v                          |
+--------+---------+      +---------+----------+
|                  |      |                     |
|   Next.js API    |      |   worker-publish    |
|   (tRPC + REST)  |      |   (BullMQ)          |
|                  |      |                     |
+----+------+------+      +----------^----------+
     |      |                        |
     |      |              +---------+----------+
     |      |              |                     |
     |      +-------+----->|      Redis 7        |
     |              |      |   (BullMQ queues)   |
     |              |      |                     |
     |              |      +---+-----+-----+----+
     |              |          |     |     |
     v              |          v     v     v
+----+------+  +----+--+  +---+-+ +-+-+ +-+---+
|           |  |       |  | stt | |llm| |video|
| PostgreSQL|  |  S3   |  |     | |   | |     |
|   16      |  |Storage|  +--+--+ +-+-+ +--+--+
|           |  |       |     |      |      |
+-----------+  +-------+     v      v      v
                          +--+------+------+---+
                          |                     |
                          |    Cloud.ru AI /    |
                          |    Global AI API    |
                          |                     |
                          +---------------------+
```

---

## 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```
clipmaker/
+-- apps/
|   +-- web/                        # Next.js 15 (frontend + API)
|   |   +-- app/                    # App Router
|   |   |   +-- (auth)/             # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: login, register,
|   |   |   |                       #   forgot-password, verify-email
|   |   |   +-- (dashboard)/        # –î–∞—à–±–æ—Ä–¥: –≤–∏–¥–µ–æ, –∫–ª–∏–ø—ã,
|   |   |   |                       #   –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∫–æ–º–∞–Ω–¥–∞
|   |   |   +-- api/                # API-–º–∞—Ä—à—Ä—É—Ç—ã + tRPC
|   |   |   +-- invite/             # –ü—Ä–∏–Ω—è—Ç–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ –∫–æ–º–∞–Ω–¥—É
|   |   +-- components/             # React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
|   |   |   +-- analytics/          # –ì—Ä–∞—Ñ–∏–∫–∏, —Ç–∞–±–ª–∏—Ü—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
|   |   |   +-- clip-editor/        # –†–µ–¥–∞–∫—Ç–æ—Ä –∫–ª–∏–ø–æ–≤ (—Ç–∞–π–º–ª–∞–π–Ω, —Å—É–±—Ç–∏—Ç—Ä—ã)
|   |   |   +-- clips/              # –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∏–ø–æ–≤, –ø—É–±–ª–∏–∫–∞—Ü–∏—è
|   |   |   +-- dashboard/          # –í–∏–¥–∂–µ—Ç—ã –¥–∞—à–±–æ—Ä–¥–∞
|   |   |   +-- layout/             # –ù–∞–≤–∏–≥–∞—Ü–∏—è
|   |   |   +-- settings/           # BYOK-–∫–ª—é—á–∏
|   |   |   +-- team/               # –ö–æ–º–∞–Ω–¥–∞
|   |   |   +-- transcript/         # –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
|   |   |   +-- upload/             # –ó–∞–≥—Ä—É–∑—á–∏–∫ –≤–∏–¥–µ–æ
|   |   |   +-- video/              # –î–µ—Ç–∞–ª–∏ –≤–∏–¥–µ–æ
|   |   |   +-- ui/                 # shadcn/ui (button, card, badge...)
|   |   +-- lib/                    # –£—Ç–∏–ª–∏—Ç—ã (auth, s3, trpc, etc.)
|   |
|   +-- worker/                     # BullMQ –≤–æ—Ä–∫–µ—Ä—ã
|       +-- workers/
|       |   +-- stt.ts              # –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è (Whisper)
|       |   +-- llm-analyze.ts      # AI-–∞–Ω–∞–ª–∏–∑ –º–æ–º–µ–Ω—Ç–æ–≤
|       |   +-- video-render.ts     # FFmpeg —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
|       |   +-- publish.ts          # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
|       |   +-- stats-collector.ts  # –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º
|       |   +-- billing-cron.ts     # –ë–∏–ª–ª–∏–Ω–≥: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤
|       |   +-- download.ts         # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ –ø–æ URL
|       +-- lib/
|           +-- llm-router.ts       # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è LLM-–º–æ–¥–µ–ª–µ–π
|           +-- providers/          # –ê–¥–∞–ø—Ç–µ—Ä—ã AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
|
+-- packages/
|   +-- db/                         # Prisma ORM
|   |   +-- prisma/
|   |       +-- schema.prisma       # –°—Ö–µ–º–∞ –ë–î
|   |       +-- migrations/         # –ú–∏–≥—Ä–∞—Ü–∏–∏
|   +-- queue/                      # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π BullMQ
|   +-- types/                      # –û–±—â–∏–µ TypeScript-—Ç–∏–ø—ã
|   |   +-- src/
|   |       +-- user.ts             # Plans, PlanId, PLANS
|   |       +-- billing.ts          # PLAN_CONFIG, —Ü–µ–Ω—ã
|   +-- config/                     # –û–±—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
|
+-- docker-compose.yml              # –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
+-- Dockerfile                      # –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–∑ (Node.js + FFmpeg)
+-- turbo.json                      # Turborepo –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
+-- package.json                    # Root package.json (workspaces)
```

---

## 4. Web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Next.js)

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

| –°–ª–æ–π | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
|------|-----------|
| Framework | Next.js 15 (App Router) |
| UI | React 19 + shadcn/ui + Tailwind CSS |
| –°–æ—Å—Ç–æ—è–Ω–∏–µ (—Å–µ—Ä–≤–µ—Ä) | React Query (TanStack Query) |
| –°–æ—Å—Ç–æ—è–Ω–∏–µ (–∫–ª–∏–µ–Ω—Ç) | Zustand |
| –í–∞–ª–∏–¥–∞—Ü–∏—è | Zod |
| –ò–∫–æ–Ω–∫–∏ | Lucide React |

### –†–µ–Ω–¥–µ—Ä–∏–Ω–≥

| –¢–∏–ø —Å—Ç—Ä–∞–Ω–∏—Ü—ã | –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ | –ü—Ä–∏–º–µ—Ä |
|-------------|----------|--------|
| Landing, SEO | SSR (Server-Side Rendering) | `/` |
| –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è | Server Components | `/login`, `/register` |
| –î–∞—à–±–æ—Ä–¥ | Client Components | `/dashboard/*` |
| API | Server-side | `/api/*` |

### –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (App Router)

```
app/
+-- page.tsx                                    # / (–ª–µ–Ω–¥–∏–Ω–≥)
+-- layout.tsx                                  # –ö–æ—Ä–Ω–µ–≤–æ–π layout
+-- (auth)/
|   +-- layout.tsx                              # Layout –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
|   +-- login/page.tsx                          # /login
|   +-- register/page.tsx                       # /register
|   +-- forgot-password/page.tsx                # /forgot-password
|   +-- reset-password/page.tsx                 # /reset-password
|   +-- verify-email/page.tsx                   # /verify-email
+-- (dashboard)/
|   +-- layout.tsx                              # Layout –¥–∞—à–±–æ—Ä–¥–∞ (–Ω–∞–≤–∏–≥–∞—Ü–∏—è)
|   +-- dashboard/
|       +-- page.tsx                            # /dashboard (—Å–ø–∏—Å–æ–∫ –≤–∏–¥–µ–æ)
|       +-- upload/page.tsx                     # /dashboard/upload
|       +-- analytics/page.tsx                  # /dashboard/analytics
|       +-- billing/page.tsx                    # /dashboard/billing
|       +-- team/page.tsx                       # /dashboard/team
|       +-- settings/
|       |   +-- page.tsx                        # /dashboard/settings (–ø—Ä–æ—Ñ–∏–ª—å + AI)
|       |   +-- platforms/page.tsx              # /dashboard/settings/platforms
|       |   +-- api-keys/page.tsx               # /dashboard/settings/api-keys
|       +-- videos/
|           +-- [videoId]/
|               +-- page.tsx                    # /dashboard/videos/:id (–¥–µ—Ç–∞–ª–∏)
|               +-- clips/[clipId]/edit/page.tsx # –†–µ–¥–∞–∫—Ç–æ—Ä –∫–ª–∏–ø–∞
+-- api/                                        # API Routes
+-- invite/page.tsx                             # /invite (–ø—Ä–∏–Ω—è—Ç–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è)
```

---

## 5. API-—Å–ª–æ–π (tRPC)

API –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ tRPC -- —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–º RPC-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–µ:

```
–ö–ª–∏–µ–Ω—Ç (React) --tRPC--> –°–µ—Ä–≤–µ—Ä (Next.js API)
                          |
                          +-- Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è
                          +-- JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                          +-- Prisma ORM
                          +-- BullMQ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á)
```

### tRPC Routers

| Router | –ü—Ä–æ—Ü–µ–¥—É—Ä—ã | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|----------|-----------|
| `video` | upload, list, get, delete | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ |
| `clip` | list, get, update, download | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–ø–∞–º–∏ |
| `user` | me, updateProfile, updatePreference | –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `billing` | plans, subscribe, cancel, usage | –ë–∏–ª–ª–∏–Ω–≥ |
| `publish` | publish, status | –ê–≤—Ç–æ-–ø–æ—Å—Ç–∏–Ω–≥ |
| `analytics` | overview, byPlatform, topClips, timeline | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ |
| `team` | create, invite, members, remove | –ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞ |
| `platform` | list, connect, disconnect | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º |

### –í–∞–ª–∏–¥–∞—Ü–∏—è

–í—Å–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç Zod-–≤–∞–ª–∏–¥–∞—Ü–∏—é:

```typescript
// –ü—Ä–∏–º–µ—Ä: –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
const uploadSchema = z.object({
  title: z.string().min(1).max(255),
  sourceType: z.enum(['upload', 'url']),
  sourceUrl: z.string().url().optional(),
  fileSize: z.number().max(4 * 1024 * 1024 * 1024), // 4 GB
});
```

### Rate Limiting

| –≠–Ω–¥–ø–æ–∏–Ω—Ç | –õ–∏–º–∏—Ç |
|----------|-------|
| –í—Å–µ API | 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ | 10 –∑–∞–≥—Ä—É–∑–æ–∫/—á–∞—Å |
| –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è | 5 –ø–æ–ø—ã—Ç–æ–∫/–º–∏–Ω |

---

## 6. –§–æ–Ω–æ–≤—ã–µ –≤–æ—Ä–∫–µ—Ä—ã (BullMQ)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—á–µ—Ä–µ–¥–µ–π

```
        Redis (BullMQ)
            |
    +-------+-------+-------+-------+
    |       |       |       |       |
  [stt]  [llm]  [video] [publish] [stats]
    |       |       |       |       |
    v       v       v       v       v
 Whisper  LLM     FFmpeg  VK/RT/  Cron
  API    Router   render  DZ/TG  6 —á–∞—Å–æ–≤
```

### –û–ø–∏—Å–∞–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤

| –í–æ—Ä–∫–µ—Ä | –§–∞–π–ª | –û—á–µ—Ä–µ–¥—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|------|---------|-----------|
| STT | `stt.ts` | `stt` | –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É–¥–∏–æ –≤ Whisper, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç |
| LLM Analyze | `llm-analyze.ts` | `llm-analyze` | –í—ã–±–æ—Ä –º–æ–º–µ–Ω—Ç–æ–≤, virality scoring, –∑–∞–≥–æ–ª–æ–≤–∫–∏ |
| Video Render | `video-render.ts` | `video-render` | FFmpeg: –Ω–∞—Ä–µ–∑–∫–∞, —Å—É–±—Ç–∏—Ç—Ä—ã, —Ä–µ—Å–∞–π–∑ |
| Publish | `publish.ts` | `publish` | –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–ø–æ–≤ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã |
| Stats Collector | `stats-collector.ts` | cron | –°–±–æ—Ä –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤/–ª–∞–π–∫–æ–≤ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º (–∫–∞–∂–¥—ã–µ 6—á) |
| Billing Cron | `billing-cron.ts` | cron | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–ª–ª–∏–Ω–≥–æ–≤—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ |
| Download | `download.ts` | `download` | –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ –ø–æ URL |

### Retry-–ø–æ–ª–∏—Ç–∏–∫–∞

```
–í—Å–µ –≤–æ—Ä–∫–µ—Ä—ã:
  attempts: 3
  backoff:
    type: exponential
    delay: 30000  (30 —Å–µ–∫, 1 –º–∏–Ω, 2 –º–∏–Ω)
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ó–∞–¥–∞—á–∏ |
|-----------|--------|
| 1 (–≤—ã—Å–æ–∫–∏–π) | –ü–ª–∞—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (Start, Pro, Business) |
| 2 (—Å—Ä–µ–¥–Ω–∏–π) | –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ |
| 3 (–Ω–∏–∑–∫–∏–π) | Stats collection, billing cron |

---

## 7. LLM Router

LLM Router -- —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É—é—â–∏–π AI-–∑–∞–¥–∞—á–∏ –∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏.

### –ß–µ—Ç—ã—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞

```
+----------------------------------------------------------+
|                      LLM ROUTER                           |
|                                                           |
|  –í—Ö–æ–¥: –∑–∞–¥–∞—á–∞, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ, –ø–ª–∞–Ω, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è        |
|                                                           |
|  +-- TIER 0: MICRO (–ø—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏) ------+               |
|  |   RU: GigaChat3-10B (10 —Ä—É–±./1M)      |               |
|  |   Global: Gemini Flash Lite            |               |
|  |   –ó–∞–¥–∞—á–∏: –∑–∞–≥–æ–ª–æ–≤–∫–∏, CTA              |               |
|  +----------------------------------------+               |
|                                                           |
|  +-- TIER 1: DEFAULT (–æ—Å–Ω–æ–≤–Ω–æ–π) ----------+               |
|  |   RU: T-Pro 2.1 (35 —Ä—É–±./1M)          |               |
|  |   Global: Gemini 2.0 Flash            |               |
|  |   –ó–∞–¥–∞—á–∏: –º–æ–º–µ–Ω—Ç-—Å–µ–ª–µ–∫—Ü–∏—è, scoring    |               |
|  +----------------------------------------+               |
|                                                           |
|  +-- TIER 2: QUALITY (–ø—Ä–µ–º–∏—É–º/retry) -----+               |
|  |   RU: Qwen3-235B (17-70 —Ä—É–±./1M)      |               |
|  |   Global: Claude Haiku 4.5            |               |
|  |   –ó–∞–¥–∞—á–∏: –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω, retry          |               |
|  +----------------------------------------+               |
|                                                           |
|  +-- TIER 3: LONG CONTEXT (–¥–ª–∏–Ω–Ω—ã–µ –≤–∏–¥–µ–æ) +               |
|  |   RU: GLM-4.6 (55 —Ä—É–±./1M, 200K ctx)  |               |
|  |   Global: Gemini 2.5 Pro              |               |
|  |   –ó–∞–¥–∞—á–∏: –≤–µ–±–∏–Ω–∞—Ä—ã > 2.5 —á–∞—Å–æ–≤        |               |
|  +----------------------------------------+               |
+----------------------------------------------------------+
```

### –õ–æ–≥–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)

```
function selectModel(task, videoDuration, plan, strategy):

  if task == "transcription":
    return strategy == "ru" ? "cloud.ru/whisper" : "openai/whisper"

  if task in ["title", "cta"]:
    return TIER_0[strategy]    // Micro: –¥–µ—à—ë–≤–∞—è –º–æ–¥–µ–ª—å

  if videoDuration > 150 min:
    return TIER_3[strategy]    // Long context

  if plan == "business" || isRetry:
    return TIER_2[strategy]    // Quality

  return TIER_1[strategy]      // Default
```

### Fallback-—Ü–µ–ø–æ—á–∫–∞

```
TIER_1 (T-Pro) ‚Üí –æ—à–∏–±–∫–∞ ‚Üí TIER_2 (Qwen3-235B) ‚Üí –æ—à–∏–±–∫–∞ ‚Üí –æ—á–µ—Ä–µ–¥—å retry
```

---

## 8. –ö–æ–Ω–≤–µ–π–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ

### –ü–æ–ª–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä

```
1. –ó–ê–ì–†–£–ó–ö–ê
   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí —Ñ–∞–π–ª/URL ‚Üí S3

2. –¢–†–ê–ù–°–ö–†–ò–ë–ê–¶–ò–Ø (worker-stt)
   S3 ‚Üí –∞—É–¥–∏–æ ‚Üí Whisper API ‚Üí —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç —Å —Ç–∞–π–º–∫–æ–¥–∞–º–∏ ‚Üí PostgreSQL

3. AI-–ê–ù–ê–õ–ò–ó (worker-llm)
   –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç ‚Üí LLM Router ‚Üí –º–æ–º–µ–Ω—Ç-—Å–µ–ª–µ–∫—Ü–∏—è ‚Üí virality scoring
   ‚Üí –∑–∞–≥–æ–ª–æ–≤–∫–∏ ‚Üí CTA ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª–∏–ø–æ–≤ –≤ PostgreSQL

4. –†–ï–ù–î–ï–†–ò–ù–ì (worker-video)
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–ø–∞ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ):
     S3 ‚Üí —Å–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫ ‚Üí FFmpeg:
       - –ù–∞—Ä–µ–∑–∫–∞ –ø–æ —Ç–∞–π–º–∫–æ–¥–∞–º
       - –†–µ—Å–∞–π–∑ 16:9 ‚Üí 9:16 (portrait)
       - –ù–∞–ª–æ–∂–µ–Ω–∏–µ —Å—É–±—Ç–∏—Ç—Ä–æ–≤
       - –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ (Free –ø–ª–∞–Ω)
     ‚Üí –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–ø –≤ S3

5. –ì–û–¢–û–í–û
   –°—Ç–∞—Ç—É—Å –≤–∏–¥–µ–æ ‚Üí completed
   –ö–ª–∏–ø—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
```

### FFmpeg-–∫–æ–º–∞–Ω–¥—ã (–ø—Ä–∏–º–µ—Ä)

```bash
# –ù–∞—Ä–µ–∑–∫–∞ + —Ä–µ—Å–∞–π–∑ + —Å—É–±—Ç–∏—Ç—Ä—ã
ffmpeg -i input.mp4 \
  -ss 120.5 -to 165.0 \
  -vf "crop=ih*9/16:ih,scale=1080:1920,
       subtitles=subs.srt:force_style='FontSize=24,
       PrimaryColour=&Hffffff,Bold=1,Shadow=1'" \
  -c:v libx264 -preset fast -crf 23 \
  -c:a aac -b:a 128k \
  -movflags +faststart \
  output.mp4
```

---

## 9. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ-–ø–æ—Å—Ç–∏–Ω–≥–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å"
     |
     v
tRPC publish.publish()
     |
     v
BullMQ: –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å publish
     |
     v
worker-publish –ø–æ–¥–±–∏—Ä–∞–µ—Ç –∑–∞–¥–∞—á—É
     |
     +-- VK API ‚Üí –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–ø ‚Üí –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
     +-- Rutube API ‚Üí –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–ø ‚Üí –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
     +-- –î–∑–µ–Ω API ‚Üí –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª–∏–ø ‚Üí –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
     +-- Telegram Bot API ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ –≤ –∫–∞–Ω–∞–ª
     |
     v
–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ PostgreSQL
```

### –ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ –∞–¥–∞–ø—Ç–µ—Ä—ã

–ö–∞–∂–¥–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–¥–∞–ø—Ç–µ—Ä —Å –µ–¥–∏–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º:

```typescript
interface PlatformAdapter {
  uploadVideo(clip: Clip, credentials: PlatformCredentials): Promise<PublishResult>;
  getStats(publicationId: string): Promise<PlatformStats>;
}
```

### Rate Limiting –ø–ª–∞—Ç—Ñ–æ—Ä–º

| –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ | –õ–∏–º–∏—Ç | –°—Ç—Ä–∞—Ç–µ–≥–∏—è |
|-----------|-------|----------|
| VK | 5 req/sec | Throttle –≤ –æ—á–µ—Ä–µ–¥–∏ |
| Rutube | –ù–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω | 1 req/sec (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π) |
| –î–∑–µ–Ω | –ù–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω | 1 req/sec (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π) |
| Telegram | 30 msg/sec | Throttle –≤ –æ—á–µ—Ä–µ–¥–∏ |

---

## 10. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### –î–∏–∞–≥—Ä–∞–º–º–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π

```
User (1) ----< (N) Video
User (1) ----< (N) Clip
User (1) ----> (0..1) Subscription
User (1) ----< (N) Payment
User (1) ----< (N) PlatformConnection
User (N) >---- (0..1) Team
Team (1) ----< (N) TeamMember

Video (1) ----> (0..1) Transcript
Video (1) ----< (N) Clip

Clip (1) ----< (N) Publication
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è |
|---------|-----------|--------------|
| `users` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | email, plan_id, minutes_used, llm_provider_preference |
| `videos` | –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ | user_id, status, duration_seconds, file_path |
| `transcripts` | –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã | video_id, segments (JSON), full_text |
| `clips` | –ù–∞—Ä–µ–∑–∞–Ω–Ω—ã–µ –∫–ª–∏–ø—ã | video_id, virality_score (JSON), file_path, status |
| `publications` | –ü—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã | clip_id, platform, status, platform_url |
| `subscriptions` | –ü–æ–¥–ø–∏—Å–∫–∏ | user_id, plan_id, status, period_end |
| `payments` | –ü–ª–∞—Ç–µ–∂–∏ | user_id, amount, status, payment_method |
| `platform_connections` | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º | user_id, platform, access_token |
| `teams` | –ö–æ–º–∞–Ω–¥—ã | name, owner_id |
| `team_members` | –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥ | team_id, user_id, role |
| `usage_records` | –ó–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è | user_id, minutes, operation |

### –°—Ç–∞—Ç—É—Å—ã –≤–∏–¥–µ–æ (lifecycle)

```
uploading ‚Üí downloading ‚Üí transcribing ‚Üí analyzing ‚Üí generating_clips ‚Üí completed
                                                                    |
                                                              (–ø—Ä–∏ –æ—à–∏–±–∫–µ)
                                                                    v
                                                                  failed
```

### –°—Ç–∞—Ç—É—Å—ã –∫–ª–∏–ø–æ–≤

```
pending ‚Üí rendering ‚Üí ready ‚Üí published
                        |
                   (–ø—Ä–∏ –æ—à–∏–±–∫–µ)
                        v
                      failed
```

---

## 11. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (NextAuth.js)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Email + –ü–∞—Ä–æ–ª—å ‚Üí bcrypt verify ‚Üí JWT (access 15 –º–∏–Ω + refresh 7 –¥–Ω–µ–π)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí VK OAuth ‚Üí callback ‚Üí create/link user ‚Üí JWT
```

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|---------|
| Access token | JWT, HttpOnly cookie, 15 –º–∏–Ω |
| Refresh token | Secure cookie, 7 –¥–Ω–µ–π |
| –ü–∞—Ä–æ–ª—å | bcrypt, –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤ |
| Email | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è |
| Rate limit | 5 –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞/–º–∏–Ω |

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–æ–∫

–§–∞–π–ª—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –¥–≤—É–º—è —Å–ø–æ—Å–æ–±–∞–º–∏:
1. **MIME-—Ç–∏–ø** -- Content-Type –∑–∞–≥–æ–ª–æ–≤–æ–∫
2. **Magic bytes** -- –ø–µ—Ä–≤—ã–µ –±–∞–π—Ç—ã —Ñ–∞–π–ª–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞

---

## 12. –ë–∏–ª–ª–∏–Ω–≥ –∏ –ø–ª–∞—Ç–µ–∂–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∏–ª–ª–∏–Ω–≥–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ ‚Üí –ÆKassa (–ø–ª–∞—Ç—ë–∂)
                                    |
                                    v
                             Webhook ‚Üí /api/billing/webhook
                                    |
                                    v
                             –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤ –ë–î
                             –°–±—Ä–æ—Å–∏—Ç—å –º–∏–Ω—É—Ç—ã
                             –°–º–µ–Ω–∏—Ç—å plan_id
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–æ–≤ (PLAN_CONFIG)

```typescript
PLAN_CONFIG = {
  free:     { price: 0,      minutesLimit: 30,    maxClips: 3,   watermark: true,  storageDays: 3  },
  start:    { price: 99000,  minutesLimit: 120,   maxClips: 10,  watermark: false, storageDays: 30 },
  pro:      { price: 299000, minutesLimit: 1000,  maxClips: 100, watermark: false, storageDays: 90 },
  business: { price: 999000, minutesLimit: 99999, maxClips: 100, watermark: false, storageDays: 90 },
};
// –¶–µ–Ω—ã –≤ –∫–æ–ø–µ–π–∫–∞—Ö: 99000 = 990 —Ä—É–±.
```

### Billing Cron

–§–æ–Ω–æ–≤—ã–π –≤–æ—Ä–∫–µ—Ä `billing-cron.ts` –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
- –ü—Ä–æ–≤–µ—Ä–∫—É –∏—Å—Ç—ë–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- –°–±—Ä–æ—Å minutes_used –≤ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

---

## 13. –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ API-–∫–ª—é—á–µ–π (BYOK)

### –ü—Ä–∏–Ω—Ü–∏–ø Zero-Knowledge

–°–µ—Ä–≤–µ—Ä –ö–ª–∏–ø–ú–µ–π–∫–µ—Ä –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –æ—Ç–∫—Ä—ã—Ç—ã–µ API-–∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç API-–∫–ª—é—á –≤ –±—Ä–∞—É–∑–µ—Ä–µ

2. –ë—Ä–∞—É–∑–µ—Ä:
   - –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - PBKDF2 (–ø–∞—Ä–æ–ª—å, salt, 100K+ –∏—Ç–µ—Ä–∞—Ü–∏–π) ‚Üí Master Key
   - AES-GCM 256-bit encrypt(Master Key, API-–∫–ª—é—á) ‚Üí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ IndexedDB –±—Ä–∞—É–∑–µ—Ä–∞

3. –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∏–¥–µ–æ:
   - –ë—Ä–∞—É–∑–µ—Ä —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –∫–ª—é—á –≤ –ø–∞–º—è—Ç–∏
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª—é—á –Ω–∞ –±—ç–∫–µ–Ω–¥ –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –∑–∞–≥–æ–ª–æ–≤–∫–µ
   - –ë—ç–∫–µ–Ω–¥: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª—é—á –¥–ª—è –æ–¥–Ω–æ–≥–æ API-–≤—ã–∑–æ–≤–∞ ‚Üí —É–¥–∞–ª—è–µ—Ç –∏–∑ –ø–∞–º—è—Ç–∏

4. –ê–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞:
   - –ß–µ—Ä–µ–∑ 30 –º–∏–Ω –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ Master Key –æ—á–∏—â–∞–µ—Ç—Å—è –∏–∑ –ø–∞–º—è—Ç–∏
   - –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–ª—é—á–µ–π –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å
```

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
|-----------|-----------|
| –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ | Web Crypto API (AES-GCM 256-bit) |
| –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è | PBKDF2 –∏–∑ –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (100K+ –∏—Ç–µ—Ä–∞—Ü–∏–π) |
| –•—Ä–∞–Ω–∏–ª–∏—â–µ | IndexedDB (–±—Ä–∞—É–∑–µ—Ä) |
| –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç | HTTPS (TLS 1.3) |
| –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ | 30 –º–∏–Ω (auto-lock) |

### –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä

- –ù–µ —Ö—Ä–∞–Ω–∏—Ç –æ—Ç–∫—Ä—ã—Ç—ã–µ API-–∫–ª—é—á–∏
- –ù–µ –ª–æ–≥–∏—Ä—É–µ—Ç –∫–ª—é—á–∏ (–¥–∞–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ)
- –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ localStorage/sessionStorage
- –ù–µ –≤–∫–ª—é—á–∞–µ—Ç –∫–ª—é—á–∏ –≤ –æ—Ç—á–µ—Ç—ã –æ–± –æ—à–∏–±–∫–∞—Ö

---

## üîÑ –û—Ç–ª–∏—á–∏—è Dev –∏ Prod —Å—Ä–µ–¥

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ö–ª–∏–ø–ú–µ–π–∫–µ—Ä –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Å—Ä–µ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —É—Å–ª–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É. –ù–∏–∂–µ –æ–ø–∏—Å–∞–Ω—ã –∫–ª—é—á–µ–≤—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É Dev –∏ Prod.

### S3 Proxy Layer (—Ç–æ–ª—å–∫–æ Dev)

–í Dev-—Å—Ä–µ–¥–µ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º (MinIO) –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–∫—Å–∏-—Å–ª–æ–π:

```
Dev:   –ë—Ä–∞—É–∑–µ—Ä ‚Üí /api/clips/[clipId]/stream ‚Üí Next.js API ‚Üí MinIO (localhost:9000)
                  (NEXT_PUBLIC_USE_S3_PROXY=true)

Prod:  –ë—Ä–∞—É–∑–µ—Ä ‚Üí Presigned URL ‚Üí S3 –Ω–∞–ø—Ä—è–º—É—é (Cloud.ru / Yandex)
                  (NEXT_PUBLIC_USE_S3_PROXY=false)
```

| –ê—Å–ø–µ–∫—Ç | Dev (Proxy) | Prod (Presigned URLs) |
|--------|-------------|----------------------|
| **–ú–∞—Ä—à—Ä—É—Ç** | `/api/clips/` API routes | –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ S3 |
| **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä** | –í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ Next.js | –ù—É–ª–µ–≤–∞—è (S3 –æ—Ç–¥–∞—ë—Ç —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é) |
| **–ü—Ä–∏—á–∏–Ω–∞** | MinIO –Ω–∞ localhost –Ω–µ –æ—Ç–¥–∞—ë—Ç presigned URLs –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ | Presigned URLs -- —à—Ç–∞—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º S3 |

### Ethereal Email Adapter (—Ç–æ–ª—å–∫–æ Dev)

–í Dev-—Å—Ä–µ–¥–µ email-–ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Ethereal -- —Ñ–µ–π–∫–æ–≤—ã–π SMTP-—Å–µ—Ä–≤–∏—Å:

```
Dev:   –í–æ—Ä–∫–µ—Ä/API ‚Üí Ethereal SMTP ‚Üí Preview URL –≤ console.log
       (SMTP_HOST –Ω–µ –∑–∞–¥–∞–Ω ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ Ethereal)

Prod:  –í–æ—Ä–∫–µ—Ä/API ‚Üí –†–µ–∞–ª—å–Ω—ã–π SMTP (smtp.yandex.ru:465) ‚Üí Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
       (SMTP_HOST –∑–∞–¥–∞–Ω –≤ .env)
```

| –ê—Å–ø–µ–∫—Ç | Dev (Ethereal) | Prod (SMTP) |
|--------|---------------|-------------|
| **–û—Ç–ø—Ä–∞–≤–∫–∞** | `console.log` + Ethereal preview URL | –†–µ–∞–ª—å–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —á–µ—Ä–µ–∑ SMTP |
| **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è email** | –ê–≤—Ç–æ-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (`NODE_ENV === 'development'`) | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ |
| **Worker emails** | `console.log` (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏) | SMTP –æ—Ç–ø—Ä–∞–≤–∫–∞ |

### globalThis Prisma Caching (—Ç–æ–ª—å–∫–æ Dev)

–í Dev-—Å—Ä–µ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è Prisma Client —á–µ—Ä–µ–∑ `globalThis` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø—Ä–∏ hot-reload:

```typescript
// Dev: Prisma Client –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ globalThis
const globalForPrisma = globalThis as unknown as { prisma: PrismaClient };
export const prisma = globalForPrisma.prisma ?? new PrismaClient({ log: ['query', 'error', 'warn'] });
if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;

// Prod: –ù–æ–≤—ã–π –∏–Ω—Å—Ç–∞–Ω—Å PrismaClient (–±–µ–∑ globalThis)
export const prisma = new PrismaClient({ log: ['error'] });
```

| –ê—Å–ø–µ–∫—Ç | Dev | Prod |
|--------|-----|------|
| **Prisma Client** | –ö–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ `globalThis` | –ù–æ–≤—ã–π –∏–Ω—Å—Ç–∞–Ω—Å |
| **DB log level** | `query` + `error` + `warn` (–≤—Å–µ SQL –≤–∏–¥–Ω—ã) | `error` only |
| **Hot-reload** | –ë–µ–∑–æ–ø–∞—Å–µ–Ω (–æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) | –ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ (–Ω–µ—Ç hot-reload) |

### Cookie Security

| –ê—Å–ø–µ–∫—Ç | Dev | Prod |
|--------|-----|------|
| **Cookie Secure flag** | `false` (HTTP –Ω–∞ localhost) | `true` (HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω) |
| **Cookie Secure –≤ Codespaces** | `true` (Codespaces –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ HTTPS) | `true` |
| **HTTPS** | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | TLS 1.3 —á–µ—Ä–µ–∑ nginx + Let's Encrypt |
| **HSTS** | –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è | `max-age=31536000; includeSubDomains` |

### Logging Pipeline

```
Dev:   Pino ‚Üí pino-pretty (—Ü–≤–µ—Ç–Ω–æ–π, —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏)
       Prisma ‚Üí query + error + warn (–≤—Å–µ SQL –≤–∏–¥–Ω—ã)

Prod:  Pino ‚Üí JSON (stdout) ‚Üí Docker json-file driver ‚Üí Loki/ELK (–∞–≥—Ä–µ–≥–∞—Ü–∏—è)
       Prisma ‚Üí error only
```

| –ê—Å–ø–µ–∫—Ç | Dev | Prod |
|--------|-----|------|
| **Pino —Ñ–æ—Ä–º–∞—Ç** | `pino-pretty` (—Ü–≤–µ—Ç–Ω–æ–π) | JSON (–º–∞—à–∏–Ω–Ω–æ-–ø–∞—Ä—Å–∏–º—ã–π) |
| **Prisma –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | `['query', 'error', 'warn']` | `['error']` |
| **–†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤** | –ù–µ—Ç (Docker defaults) | `json-file`, max 50 –ú–ë, 5 —Ñ–∞–π–ª–æ–≤ |
| **–¶–µ–ª—å –ª–æ–≥–æ–≤** | –ö–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ | –°–∏—Å—Ç–µ–º–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ (Grafana Loki) |

### OAuth –ø–ª–∞—Ç—Ñ–æ—Ä–º

```
Dev:   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "–ü–æ–¥–∫–ª—é—á–∏—Ç—å VK" ‚Üí –°–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
       (—Ñ–∏–∫—Ç–∏–≤–Ω—ã–π —Ç–æ–∫–µ–Ω, –±–µ–π–¥–∂ "(dev)" –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ)

Prod:  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "–ü–æ–¥–∫–ª—é—á–∏—Ç—å VK" ‚Üí Redirect –Ω–∞ VK OAuth ‚Üí
       –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí Callback ‚Üí –†–µ–∞–ª—å–Ω—ã–π access_token
```

| –ê—Å–ø–µ–∫—Ç | Dev | Prod |
|--------|-----|------|
| **OAuth VK/–î–∑–µ–Ω** | Dev-mode –∑–∞–≥–ª—É—à–∫–∞ —Å —Ñ–∏–∫—Ç–∏–≤–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏ | –†–µ–∞–ª—å–Ω—ã–π OAuth 2.0 flow |
| **Env-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** | `VK_PUBLISH_CLIENT_ID` –Ω–µ –∑–∞–¥–∞–Ω | `VK_PUBLISH_CLIENT_ID`, `YANDEX_CLIENT_ID` –∑–∞–¥–∞–Ω—ã |
| **–ü—É–±–ª–∏–∫–∞—Ü–∏—è** | –ù–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç (—Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã) | –†–µ–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã |

### –°–≤–æ–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞

```
         Dev                                     Prod
+--------------------+                  +--------------------+
| Browser            |                  | Browser            |
|  - S3 Proxy mode   |                  |  - Presigned URLs  |
|  - Ethereal emails |                  |  - Real emails     |
|  - OAuth stubs     |                  |  - Real OAuth      |
|  - HTTP cookies    |                  |  - Secure cookies  |
+--------+-----------+                  +--------+-----------+
         |                                       |
  HTTP (localhost:3000)                  HTTPS (nginx:443)
         |                                       |
+--------+-----------+                  +--------+-----------+
| Next.js            |                  | Next.js            |
|  - pino-pretty     |                  |  - JSON logs       |
|  - globalThis PG   |                  |  - New PrismaClient|
|  - SQL query logs  |                  |  - Error-only logs |
|  - S3 proxy routes |                  |  - No proxy routes |
+--------+-----------+                  +--------+-----------+
         |                                       |
+--------+-----------+                  +--------+-----------+
| MinIO (localhost)  |                  | Cloud.ru S3        |
| PostgreSQL (:5432) |                  | PostgreSQL (Docker) |
| Redis (:6379)      |                  | Redis (Docker)     |
+--------------------+                  +--------------------+
```
