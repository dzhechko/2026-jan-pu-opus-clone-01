# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ö–ª–∏–ø–ú–µ–π–∫–µ—Ä

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á](#1-–æ–±–∑–æ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö-–∑–∞–¥–∞—á)
2. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã](#2-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-—Å–∏—Å—Ç–µ–º—ã)
3. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏](#3-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
4. [–ë–∏–ª–ª–∏–Ω–≥ –∏ –ø–æ–¥–ø–∏—Å–∫–∏](#4-–±–∏–ª–ª–∏–Ω–≥-–∏-–ø–æ–¥–ø–∏—Å–∫–∏)
5. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏](#5-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–æ—á–µ—Ä–µ–¥—è–º–∏-–æ–±—Ä–∞–±–æ—Ç–∫–∏)
6. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º](#6-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º)
7. [AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏ LLM Router](#7-ai-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã-–∏-llm-router)
8. [–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ](#8-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
9. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#9-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
10. [–†–µ–≥–ª–∞–º–µ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã](#10-—Ä–µ–≥–ª–∞–º–µ–Ω—Ç–Ω—ã–µ-—Ä–∞–±–æ—Ç—ã)
11. [–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ](#11-–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
12. [–ê–≤–∞—Ä–∏–π–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã](#12-–∞–≤–∞—Ä–∏–π–Ω—ã–µ-–ø—Ä–æ—Ü–µ–¥—É—Ä—ã)

---

## 1. –û–±–∑–æ—Ä –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á

–ö–ª–∏–ø–ú–µ–π–∫–µ—Ä –Ω–µ –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –≤ MVP. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑:

| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|-----------|
| `psql` / Prisma Studio | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –≤ –ë–î |
| Docker Compose CLI | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ |
| Redis CLI | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π |
| nginx logs | –ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞ |
| –°–∏—Å—Ç–µ–º–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã | CPU, RAM, –¥–∏—Å–∫ |

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

```bash
cd /opt/clipmaker

# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose -f docker-compose.prod.yml ps

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose -f docker-compose.prod.yml logs --tail 20

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
docker compose -f docker-compose.prod.yml exec postgres \
  psql -U clipmaker clipmaker
```

---

## 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã

### 2.1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
docker stats --no-stream

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# CONTAINER     CPU%   MEM USAGE / LIMIT   NET I/O
# web           2.5%   450MiB / 2GiB       5MB / 2MB
# worker-video  45%    1.2GiB / 4GiB       100MB / 50MB
# postgres      1.0%   300MiB / 2GiB       1MB / 500KB
# redis         0.5%   50MiB / 512MiB      200KB / 100KB
```

### 2.2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ PostgreSQL

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
docker compose -f docker-compose.prod.yml exec postgres \
  psql -U clipmaker clipmaker

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
SELECT count(*) FROM pg_stat_activity WHERE state = 'active';

-- –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
SELECT pg_size_pretty(pg_database_size('clipmaker'));

-- –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü
SELECT relname, pg_size_pretty(pg_total_relation_size(relid))
FROM pg_catalog.pg_statio_user_tables
ORDER BY pg_total_relation_size(relid) DESC
LIMIT 10;

-- –î–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã (>5 —Å–µ–∫—É–Ω–¥)
SELECT pid, now() - pg_stat_activity.query_start AS duration, query
FROM pg_stat_activity
WHERE (now() - pg_stat_activity.query_start) > interval '5 seconds'
AND state != 'idle';

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
SELECT status, count(*) FROM videos GROUP BY status;

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–ø–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
SELECT status, count(*) FROM clips GROUP BY status;
```

### 2.3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Redis –∏ –æ—á–µ—Ä–µ–¥–µ–π

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
docker compose -f docker-compose.prod.yml exec redis redis-cli

# –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
INFO memory
INFO clients
INFO stats

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥—è—Ö BullMQ
LLEN bull:stt:wait
LLEN bull:llm-analyze:wait
LLEN bull:video-render:wait
LLEN bull:publish:wait

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
LLEN bull:stt:active
LLEN bull:video-render:active

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–¥–∞—á
LLEN bull:stt:failed
LLEN bull:video-render:failed
```

### 2.4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

```bash
# –û–±—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
df -h /

# –†–∞–∑–º–µ—Ä Docker-—Ç–æ–º–æ–≤
docker system df

# –î–µ—Ç–∞–ª–∏ –ø–æ —Ç–æ–º–∞–º
docker volume ls
docker system df -v | head -30

# –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö Docker
docker system prune -f
```

### 2.5. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∞–ª–µ—Ä—Ç—ã

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—á–µ—Ä–µ–∑ cron + email/Telegram) –ø—Ä–∏:

| –£—Å–ª–æ–≤–∏–µ | –ü–æ—Ä–æ–≥ | –î–µ–π—Å—Ç–≤–∏–µ |
|---------|-------|----------|
| CPU > 80% | 5 –º–∏–Ω –ø–æ–¥—Ä—è–¥ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å worker-video |
| RAM > 90% | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ | –£–≤–µ–ª–∏—á–∏—Ç—å RAM –∏–ª–∏ –ª–∏–º–∏—Ç—ã |
| –î–∏—Å–∫ > 85% | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ | –û—á–∏—Å—Ç–∫–∞ S3 / —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ |
| –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–ø–∞–ª | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å |
| –û—á–µ—Ä–µ–¥—å > 100 –∑–∞–¥–∞—á | 10 –º–∏–Ω | –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –≤–æ—Ä–∫–µ—Ä—ã |
| –û—à–∏–±–∫–∏ 5xx > 10/–º–∏–Ω | 5 –º–∏–Ω | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ web |

---

## 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### 3.1. –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```sql
-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
SELECT id, email, plan_id, minutes_used, minutes_limit,
       llm_provider_preference, created_at
FROM users ORDER BY created_at DESC LIMIT 20;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ –ø–ª–∞–Ω–∞–º
SELECT plan_id, count(*) as user_count
FROM users GROUP BY plan_id;

-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–∑–∞–≥—Ä—É–∂–∞–ª–∏ –≤–∏–¥–µ–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
SELECT u.email, u.plan_id, count(v.id) as videos_count
FROM users u
JOIN videos v ON v.user_id = u.id
WHERE v.created_at > now() - interval '30 days'
GROUP BY u.email, u.plan_id
ORDER BY videos_count DESC;
```

### 3.2. –°–º–µ–Ω–∞ –ø–ª–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é

```sql
-- –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ Pro-–ø–ª–∞–Ω
UPDATE users
SET plan_id = 'pro',
    minutes_limit = 1000,
    minutes_used = 0,
    billing_period_start = now()
WHERE email = 'user@example.com';
```

### 3.3. –°–±—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –º–∏–Ω—É—Ç

```sql
-- –°–±—Ä–æ—Å –º–∏–Ω—É—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
UPDATE users SET minutes_used = 0 WHERE email = 'user@example.com';

-- –ú–∞—Å—Å–æ–≤—ã–π —Å–±—Ä–æ—Å –≤ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (–æ–±—ã—á–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è billing-cron)
-- –ù–ï –∑–∞–ø—É—Å–∫–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ billing-cron —Ä–∞–±–æ—Ç–∞–µ—Ç!
```

### 3.4. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–º–µ–Ω—É –ø–ª–∞–Ω–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫—É –ª–∏–º–∏—Ç–∞ –≤ 0:

```sql
UPDATE users
SET minutes_limit = 0, plan_id = 'free'
WHERE email = 'abuser@example.com';
```

### 3.5. –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
-- –í–ù–ò–ú–ê–ù–ò–ï: –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (–≤–∏–¥–µ–æ, –∫–ª–∏–ø—ã, –ø–æ–¥–ø–∏—Å–∫–∏, –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
DELETE FROM users WHERE email = 'user@example.com';
```

–§–∞–π–ª—ã –≤ S3 –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ (—Å–º. —Ä–∞–∑–¥–µ–ª 6).

---

## 4. –ë–∏–ª–ª–∏–Ω–≥ –∏ –ø–æ–¥–ø–∏—Å–∫–∏

### 4.1. –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

| –ü–ª–∞–Ω | –¶–µ–Ω–∞ | –ú–∏–Ω—É—Ç—ã/–º–µ—Å | –ö–ª–∏–ø–æ–≤/–≤–∏–¥–µ–æ | –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ | –ê–≤—Ç–æ-–ø–æ—Å—Ç–∏–Ω–≥ | –•—Ä–∞–Ω–µ–Ω–∏–µ |
|------|------|-----------|-------------|-------------|-------------|---------|
| Free | 0 | 30 | 3 | –î–∞ | –ù–µ—Ç | 3 –¥–Ω—è |
| Start | 990 —Ä—É–±. | 120 | 10 | –ù–µ—Ç | VK | 30 –¥–Ω–µ–π |
| Pro | 2 990 —Ä—É–±. | 1 000 | 100 | –ù–µ—Ç | VK, Rutube, Dzen, Telegram | 90 –¥–Ω–µ–π |
| Business | 9 990 —Ä—É–±. | –ë–µ–∑–ª–∏–º–∏—Ç | 100 | –ù–µ—Ç | VK, Rutube, Dzen, Telegram | 90 –¥–Ω–µ–π |

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∏–Ω—É—Ç—ã: 15 —Ä—É–±./–º–∏–Ω (–¥–ª—è –ø–ª–∞–Ω–æ–≤ Start –∏ –≤—ã—à–µ).

### 4.2. –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–¥–ø–∏—Å–æ–∫

```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
SELECT u.email, s.plan_id, s.status, s.period_start, s.period_end
FROM subscriptions s
JOIN users u ON u.id = s.user_id
WHERE s.status = 'active'
ORDER BY s.period_end;

-- –ü–æ–¥–ø–∏—Å–∫–∏ —Å –∏—Å—Ç–µ–∫–∞—é—â–∏–º —Å—Ä–æ–∫–æ–º (7 –¥–Ω–µ–π)
SELECT u.email, s.plan_id, s.period_end
FROM subscriptions s
JOIN users u ON u.id = s.user_id
WHERE s.status = 'active'
AND s.period_end < now() + interval '7 days';
```

### 4.3. –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞—Ç–µ–∂–µ–π

```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏
SELECT p.id, u.email, p.amount, p.currency, p.status,
       p.payment_method, p.payment_type, p.created_at
FROM payments p
JOIN users u ON u.id = p.user_id
ORDER BY p.created_at DESC LIMIT 20;

-- –í—ã—Ä—É—á–∫–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
SELECT sum(amount) / 100 as revenue_rub,
       count(*) as payments_count
FROM payments
WHERE status = 'succeeded'
AND created_at >= date_trunc('month', now());
```

### 4.4. –ÆKassa Webhook

–ÆKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–±—Ö—É–∫–∏ –Ω–∞ `/api/billing/webhook`. –ü—Ä–æ–≤–µ—Ä–∫–∞:

```bash
# –õ–æ–≥–∏ –≤–µ–±—Ö—É–∫–æ–≤
docker compose -f docker-compose.prod.yml logs web | grep "webhook"
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ URL –≤–µ–±—Ö—É–∫–∞ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:
- URL: `https://clipmaker.ru/api/billing/webhook`
- –°–æ–±—ã—Ç–∏–µ: `payment.succeeded`, `payment.canceled`, `refund.succeeded`

### 4.5. –†—É—á–Ω–æ–π –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

–í–æ–∑–≤—Ä–∞—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ API –ÆKassa –∏–ª–∏ –∏—Ö –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç. –ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ–±–Ω–æ–≤–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É:

```sql
-- –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞
UPDATE subscriptions
SET status = 'cancelled'
WHERE user_id = (SELECT id FROM users WHERE email = 'user@example.com');

-- –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω
UPDATE users
SET plan_id = 'free', minutes_limit = 30, minutes_used = 0
WHERE email = 'user@example.com';
```

---

## 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 5.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—á–µ—Ä–µ–¥–µ–π

```
                         Redis (BullMQ)
                              |
          +-------------------+-------------------+
          |                   |                   |
     stt queue          llm-analyze         video-render
     (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)     (AI-–∞–Ω–∞–ª–∏–∑)         (FFmpeg)
                                                  |
                                            publish queue
                                            (–∞–≤—Ç–æ-–ø–æ—Å—Ç–∏–Ω–≥)
```

### 5.2. –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π

```bash
# –ß–µ—Ä–µ–∑ Redis CLI
docker compose -f docker-compose.prod.yml exec redis redis-cli

# –ó–∞–¥–∞—á–∏ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏
LLEN bull:stt:wait
LLEN bull:llm-analyze:wait
LLEN bull:video-render:wait
LLEN bull:publish:wait

# –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
LLEN bull:stt:active
LLEN bull:video-render:active

# –ù–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–¥–∞—á–∏
ZCARD bull:stt:failed
ZCARD bull:video-render:failed
```

### 5.3. Retry –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–¥–∞—á

```bash
# –ß–µ—Ä–µ–∑ Redis CLI ‚Äî –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∏–∑ failed –æ–±—Ä–∞—Ç–Ω–æ –≤ wait
# –≠—Ç–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è; —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞
docker compose -f docker-compose.prod.yml restart worker-stt
```

### 5.4. –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–¥–∞—á

```bash
# –ï—Å–ª–∏ –∑–∞–¥–∞—á–∏ –∑–∞–≤–∏—Å–ª–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ active (–≤–æ—Ä–∫–µ—Ä —É–ø–∞–ª)
docker compose -f docker-compose.prod.yml exec redis redis-cli

# –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á active (BullMQ –ø–æ–¥–±–µ—Ä–µ—Ç –∏—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
DEL bull:stt:active
DEL bull:video-render:active

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–æ–≤
docker compose -f docker-compose.prod.yml restart worker-stt worker-video
```

### 5.5. –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –æ—á–µ—Ä–µ–¥–µ–π (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)

```bash
# –¢–æ–ª—å–∫–æ –≤ –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ ‚Äî —É–¥–∞–ª–∏—Ç –í–°–ï –∑–∞–¥–∞—á–∏
docker compose -f docker-compose.prod.yml exec redis redis-cli FLUSHDB
```

---

## 6. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º

### 6.1. –ü–æ–ª–∏—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö | Free | Start | Pro/Business |
|-----------|------|-------|-------------|
| –ò—Å—Ö–æ–¥–Ω—ã–µ –≤–∏–¥–µ–æ | 3 –¥–Ω—è | 30 –¥–Ω–µ–π | 90 –¥–Ω–µ–π |
| –ì–æ—Ç–æ–≤—ã–µ –∫–ª–∏–ø—ã | 3 –¥–Ω—è | 30 –¥–Ω–µ–π | 90 –¥–Ω–µ–π |
| –ú–∏–Ω–∏–∞—Ç—é—Ä—ã | –° –∫–ª–∏–ø–∞–º–∏ | –° –∫–ª–∏–ø–∞–º–∏ | –° –∫–ª–∏–ø–∞–º–∏ |

### 6.2. –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ–∞–π–ª–æ–≤

–°–æ–∑–¥–∞–π—Ç–µ cron-—Å–∫—Ä–∏–ø—Ç `/opt/clipmaker/scripts/cleanup-storage.sh`:

```bash
#!/bin/bash

# –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ Free-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å—Ç–∞—Ä—à–µ 3 –¥–Ω–µ–π
docker compose -f /opt/clipmaker/docker-compose.prod.yml exec -T postgres \
  psql -U clipmaker clipmaker -c "
    SELECT v.file_path, v.id
    FROM videos v
    JOIN users u ON u.id = v.user_id
    WHERE u.plan_id = 'free'
    AND v.created_at < now() - interval '3 days';
  "

# –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ S3 CLI (–µ—Å–ª–∏ s3cmd –∏–ª–∏ aws cli —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
# s3cmd del s3://clipmaker/videos/<video-id>/
```

### 6.3. –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

```sql
-- –û–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
SELECT u.email, u.plan_id,
       count(v.id) as videos,
       pg_size_pretty(coalesce(sum(v.file_size), 0)::bigint) as total_size
FROM users u
LEFT JOIN videos v ON v.user_id = u.id
GROUP BY u.email, u.plan_id
ORDER BY coalesce(sum(v.file_size), 0) DESC
LIMIT 20;
```

---

## 7. AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏ LLM Router

### 7.1. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ AI-–æ–±—Ä–∞–±–æ—Ç–∫–∏

| –°—Ç—Ä–∞—Ç–µ–≥–∏—è | –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã | –î–∞–Ω–Ω—ã–µ |
|-----------|-----------|--------|
| **RU** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | Cloud.ru: T-Pro 2.1, Whisper, GigaChat3 | –í—Å–µ –≤ –†–§ (152-–§–ó) |
| **Global** | Gemini, Claude, OpenAI Whisper | –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã –∑–∞ —Ä—É–±–µ–∂–æ–º |

### 7.2. LLM Router ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π

```
–ó–∞–¥–∞—á–∞                    ‚Üí RU-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è         ‚Üí Global-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (STT)        ‚Üí Cloud.ru Whisper      ‚Üí OpenAI Whisper
–í—ã–±–æ—Ä –º–æ–º–µ–Ω—Ç–æ–≤ (Tier 1)   ‚Üí T-Pro 2.1             ‚Üí Gemini 2.0 Flash
Virality Scoring (Tier 1) ‚Üí T-Pro 2.1             ‚Üí Gemini 2.0 Flash
–ó–∞–≥–æ–ª–æ–≤–∫–∏ (Tier 0)        ‚Üí GigaChat3-10B         ‚Üí Gemini Flash Lite
CTA (Tier 0)              ‚Üí GigaChat3-10B         ‚Üí Gemini Flash Lite
–°–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ (Tier 2)   ‚Üí Qwen3-235B            ‚Üí Claude Haiku 4.5
–î–ª–∏–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (Tier 3)    ‚Üí GLM-4.6 (200K ctx)    ‚Üí Gemini 2.5 Pro
```

### 7.3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ AI

```sql
-- –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞ –º–µ—Å—è—Ü (–≤ –∫–æ–ø–µ–π–∫–∞—Ö)
SELECT sum(processing_cost_kopecks) / 100 as total_rub,
       count(*) as videos_processed,
       avg(processing_cost_kopecks) / 100 as avg_cost_rub
FROM videos
WHERE status = 'completed'
AND created_at >= date_trunc('month', now());

-- –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º
SELECT llm_provider_used, count(*) as videos,
       sum(processing_cost_kopecks) / 100 as total_rub
FROM videos
WHERE status = 'completed'
GROUP BY llm_provider_used;
```

### 7.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Cloud.ru API
curl -s https://foundation-models.api.cloud.ru/v1/models \
  -H "Authorization: Bearer $CLOUDRU_API_KEY" | head -50

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker compose -f docker-compose.prod.yml exec web \
  printenv | grep -E "CLOUDRU|GEMINI|ANTHROPIC|OPENAI" | sed 's/=.*/=***/'
```

---

## 8. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 8.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–æ–≤

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç Pino (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON):

```bash
# –õ–æ–≥–∏ web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
docker compose -f docker-compose.prod.yml logs -f web

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞
docker compose -f docker-compose.prod.yml logs -f worker-video --tail 100

# –í—Å–µ –ª–æ–≥–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
docker compose -f docker-compose.prod.yml logs --since 1h
```

### 8.2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ª–æ–≥–æ–≤

```bash
# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
docker compose -f docker-compose.prod.yml logs web 2>&1 | grep '"level":"error"'

# –õ–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ
docker compose -f docker-compose.prod.yml logs worker-video 2>&1 | grep "videoId"

# –õ–æ–≥–∏ –ø–ª–∞—Ç–µ–∂–µ–π
docker compose -f docker-compose.prod.yml logs web 2>&1 | grep "payment\|billing\|webhook"
```

### 8.3. –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ Docker

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é –≤ `/etc/docker/daemon.json`:

```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "50m",
    "max-file": "5"
  }
}
```

```bash
sudo systemctl restart docker
```

---

## 9. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 9.1. –ß–µ–∫-–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- [ ] HTTPS —Å TLS 1.3 –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] HSTS –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∫–ª—é—á–µ–Ω
- [ ] X-Frame-Options: DENY
- [ ] Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω (100 req/min –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- [ ] –§–∞–π—Ä–≤–æ–ª —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Ä—Ç—ã 22, 80, 443
- [ ] PostgreSQL –∏ Redis –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑ Docker-—Å–µ—Ç–∏
- [ ] .env –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ 600
- [ ] –°–µ–∫—Ä–µ—Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫—Ä–∏–ø—Ç–æ—Å—Ç–æ–π–∫–∏–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–º
- [ ] –ë—ç–∫–∞–ø—ã –ë–î –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
- [ ] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 9.2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```bash
# –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ (–∏–∑ –ª–æ–≥–æ–≤)
docker compose -f docker-compose.prod.yml logs web 2>&1 | grep "auth.*fail"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤
ss -tlnp

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
openssl s_client -connect clipmaker.ru:443 -brief
```

### 9.3. API Keys ‚Äî –º–æ–¥–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```
–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–ª—é—á–∏ (VK, Gemini, etc.):
  –ë—Ä–∞—É–∑–µ—Ä ‚Üí AES-GCM —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ‚Üí IndexedDB
  –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –≤ –ø–∞–º—è—Ç–∏ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥ ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ‚Üí —É–¥–∞–ª–µ–Ω–∏–µ
  –°–µ—Ä–≤–µ—Ä –ù–ò–ö–û–ì–î–ê –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –æ—Ç–∫—Ä—ã—Ç—ã–µ –∫–ª—é—á–∏

–°–µ—Ä–≤–µ—Ä–Ω—ã–µ –∫–ª—é—á–∏ (Cloud.ru):
  –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è CLOUDRU_API_KEY ‚Üí –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```

---

## 10. –†–µ–≥–ª–∞–º–µ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### 10.1. –ï–∂–µ–¥–Ω–µ–≤–Ω–æ

| –ó–∞–¥–∞—á–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|----------|
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ | `docker compose logs --tail 50 --since 24h` |
| –ë—ç–∫–∞–ø –ë–î | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (cron), –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ |
| –û—á–µ—Ä–µ–¥–∏ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ç –ª–∏ –∑–∞—Å—Ç—Ä—è–≤—à–∏—Ö –∑–∞–¥–∞—á |

### 10.2. –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ

| –ó–∞–¥–∞—á–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|----------|
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Docker-–æ–±—Ä–∞–∑–æ–≤ | `docker compose pull` |
| –û—á–∏—Å—Ç–∫–∞ Docker | `docker system prune -f` |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL | `certbot renew --dry-run` |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ | `df -h` |

### 10.3. –ï–∂–µ–º–µ—Å—è—á–Ω–æ

| –ó–∞–¥–∞—á–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|----------|
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –û–° | `sudo apt update && sudo apt upgrade` |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞ | –¢–µ—Å—Ç-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ dev-—Å—Ä–µ–¥–µ |
| –ê–Ω–∞–ª–∏–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ AI | SQL-–∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 7.3 |
| –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ S3 | –°–∫—Ä–∏–ø—Ç cleanup-storage.sh |

---

## 11. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### 11.1. –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

| –£–∑–∫–æ–µ –º–µ—Å—Ç–æ | –†–µ—à–µ–Ω–∏–µ |
|-------------|---------|
| CPU (FFmpeg) | –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä VPS |
| RAM (PostgreSQL) | –£–≤–µ–ª–∏—á–∏—Ç—å RAM, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å shared_buffers |
| –î–∏—Å–∫ | –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–π SSD |

### 11.2. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ video-–≤–æ—Ä–∫–µ—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
docker compose -f docker-compose.prod.yml up -d --scale worker-video=3

# –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ STT-–≤–æ—Ä–∫–µ—Ä–æ–≤ (–ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ—á–µ—Ä–µ–¥—è—Ö)
docker compose -f docker-compose.prod.yml up -d --scale worker-stt=2
```

### 11.3. –û—Ä–∏–µ–Ω—Ç–∏—Ä—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | –í–∏–¥–µ–æ/–¥–µ–Ω—å | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è |
|---------------|-----------|---------------------------|
| –¥–æ 500 | –¥–æ 50 | 4 CPU, 8 GB RAM, 1 video worker |
| 500-2500 | 50-200 | 8 CPU, 16 GB RAM, 3 video workers |
| 2500+ | 200+ | 16 CPU, 32 GB RAM, 5 video workers, read replica PG |

---

## 12. –ê–≤–∞—Ä–∏–π–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã

### 12.1. –ü–æ–ª–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker
systemctl status docker

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.prod.yml up -d

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx
sudo systemctl status nginx
sudo nginx -t && sudo systemctl restart nginx
```

### 12.2. –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
docker compose -f docker-compose.prod.yml stop web worker-stt worker-llm worker-video worker-publish

# 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞
gunzip < backups/clipmaker_LATEST.sql.gz | \
  docker compose -f docker-compose.prod.yml exec -T postgres \
  psql -U clipmaker clipmaker

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
docker compose -f docker-compose.prod.yml start web
docker compose -f docker-compose.prod.yml exec web \
  npx prisma migrate deploy --schema=packages/db/prisma/schema.prisma

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã
docker compose -f docker-compose.prod.yml start worker-stt worker-llm worker-video worker-publish
```

### 12.3. –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞

```bash
# 1. –û—á–∏—Å—Ç–∫–∞ Docker
docker system prune -af --volumes

# 2. –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
find /opt/clipmaker/backups -name "*.sql.gz" -mtime +7 -delete

# 3. –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
truncate -s 0 /var/log/syslog
docker compose -f docker-compose.prod.yml logs --since 1h > /tmp/recent-logs.txt
```

### 12.4. –£—Ç–µ—á–∫–∞ API-–∫–ª—é—á–µ–π

```bash
# 1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–º–µ–Ω–∏—Ç—å –∫–ª—é—á –≤ —Å–µ—Ä–≤–∏—Å–µ-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ (Cloud.ru, –ÆKassa –∏ —Ç.–¥.)
# 2. –û–±–Ω–æ–≤–∏—Ç—å .env
nano /opt/clipmaker/.env
# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker compose -f docker-compose.prod.yml up -d
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```

---

## üîÑ –û—Ç–ª–∏—á–∏—è Dev –∏ Prod —Å—Ä–µ–¥

–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É Dev –∏ Prod —Å—Ä–µ–¥–∞–º–∏, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

| –ê—Å–ø–µ–∫—Ç | Dev | Prod |
|--------|-----|------|
| **–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤** | `pino-pretty` -- —Ü–≤–µ—Ç–Ω–æ–π, —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–π | JSON -- –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ (Loki, ELK, Grafana) |
| **–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ë–î** | `query` + `error` + `warn` (–≤—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã –≤–∏–¥–Ω—ã) | `error` only (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —à—É–º) |
| **Prisma Client** | `globalThis` –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (hot-reload –Ω–µ —Å–æ–∑–¥–∞—ë—Ç —É—Ç–µ—á–µ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π) | –ù–æ–≤—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø—É–ª) |

**–ü—Ä–∏–º–µ—Ä —Ä–∞–∑–Ω–∏—Ü—ã –≤ –ª–æ–≥–∞—Ö:**

```bash
# Dev (pino-pretty) ‚Äî —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç:
[14:32:05] INFO: Video uploaded { videoId: "abc-123", userId: "user-1" }

# Prod (JSON) ‚Äî –º–∞—à–∏–Ω–Ω–æ-–ø–∞—Ä—Å–∏–º—ã–π:
{"level":30,"time":1709041925000,"msg":"Video uploaded","videoId":"abc-123","userId":"user-1"}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ verbose SQL-–ª–æ–≥–æ–≤ –≤ Dev:**

–í Dev-—Å—Ä–µ–¥–µ –≤—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å N+1 –ø—Ä–æ–±–ª–µ–º—ã –∏ –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

```bash
# –í—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –≤–∏–¥–Ω—ã –≤ –ª–æ–≥–∞—Ö web-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker compose logs -f web | grep "prisma:query"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Email

| –ê—Å–ø–µ–∫—Ç | Dev | Prod |
|--------|-----|------|
| **SMTP-–ø—Ä–æ–≤–∞–π–¥–µ—Ä** | Ethereal (—Ñ–µ–π–∫–æ–≤—ã–π SMTP) | –†–µ–∞–ª—å–Ω—ã–π SMTP (`SMTP_HOST`, `SMTP_PORT`) |
| **–î–æ—Å—Ç–∞–≤–∫–∞ –ø–∏—Å–µ–º** | –ü–∏—Å—å–º–∞ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ | –ü–∏—Å—å–º–∞ –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º |
| **–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–∏—Å–µ–º** | Preview URL –≤ –∫–æ–Ω—Å–æ–ª–∏ (Ethereal web) | –†–µ–∞–ª—å–Ω—ã–π –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è |
| **Worker emails** | `console.log` (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏) | SMTP –æ—Ç–ø—Ä–∞–≤–∫–∞ |
| **Email-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è** | –ê–≤—Ç–æ-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ | –†–µ–∞–ª—å–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Å—Å—ã–ª–∫–µ |

**–ü—Ä–æ—Å–º–æ—Ç—Ä Ethereal-–ø–∏—Å–µ–º –≤ Dev:**

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email –≤ Dev-—Å—Ä–µ–¥–µ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è URL –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:

```bash
docker compose logs web | grep "ethereal"
# –ü—Ä–∏–º–µ—Ä: Preview URL: https://ethereal.email/message/...
```

–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∏—Å—å–º–∞ (–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è, —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –∏ —Ç.–¥.).

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π

| –ê—Å–ø–µ–∫—Ç | Dev | Prod |
|--------|-----|------|
| **–ÆKassa** | –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ `YOOKASSA_SHOP_ID`/`SECRET_KEY` | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞ |
| **Webhook** | –ù–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (–Ω–µ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ URL) | `https://clipmaker.ru/api/billing/webhook` |
| **–°–º–µ–Ω–∞ –ø–ª–∞–Ω–∞** | –¢–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π SQL-–∑–∞–ø—Ä–æ—Å –∫ –ë–î | –ß–µ—Ä–µ–∑ UI –æ–ø–ª–∞—Ç—ã |

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–ª–∏–Ω–≥–∞ –≤ Dev –±–µ–∑ –ÆKassa:**

```sql
-- –†—É—á–Ω–∞—è —Å–º–µ–Ω–∞ –ø–ª–∞–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
UPDATE users
SET plan_id = 'pro', minutes_limit = 1000, minutes_used = 0
WHERE email = 'test@example.com';
```

### –û—Ç–ª–∞–¥–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

| –ê—Å–ø–µ–∫—Ç | Dev | Prod |
|--------|-----|------|
| **PostgreSQL –ø–æ—Ä—Ç** | `5432` (–¥–æ—Å—Ç—É–ø–µ–Ω —Å —Ö–æ—Å—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é) | `127.0.0.1:5432` (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Docker-—Å–µ—Ç—å) |
| **Redis –ø–æ—Ä—Ç** | `6379` (–¥–æ—Å—Ç—É–ø–µ–Ω —Å —Ö–æ—Å—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é) | `127.0.0.1:6379` (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Docker-—Å–µ—Ç—å) |
| **Prisma Studio** | –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å (`npx prisma studio`) | –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `psql`) |
| **SQL-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤–∏–¥–Ω—ã –≤ –ª–æ–≥–∞—Ö | –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ |

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –≤ Dev (–Ω–∞–ø—Ä—è–º—É—é —Å —Ö–æ—Å—Ç–∞):**

```bash
psql postgresql://clipmaker:clipmaker@localhost:5432/clipmaker
```

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –≤ Prod (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Docker):**

```bash
docker compose -f docker-compose.prod.yml exec postgres psql -U clipmaker clipmaker
```

### OAuth –ø–ª–∞—Ç—Ñ–æ—Ä–º

| –ê—Å–ø–µ–∫—Ç | Dev | Prod |
|--------|-----|------|
| **VK, –î–∑–µ–Ω OAuth** | Dev-mode –∑–∞–≥–ª—É—à–∫–∞ (—Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å —Ñ–∏–∫—Ç–∏–≤–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏) | –†–µ–∞–ª—å–Ω—ã–π OAuth (`VK_PUBLISH_CLIENT_ID`, `YANDEX_CLIENT_ID`) |
| **Rutube, Telegram** | –í–≤–æ–¥ —Ç–æ–∫–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥—ë—Ç –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö API | –†–µ–∞–ª—å–Ω—ã–µ API-–≤—ã–∑–æ–≤—ã |
| **–ú–µ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** | –ë–µ–π–¥–∂ `(dev)` –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã | –ò–º—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ |

### –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

| –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å | –ö–æ–º–∞–Ω–¥–∞ Dev | –ö–æ–º–∞–Ω–¥–∞ Prod |
|---------------|-------------|--------------|
| –õ–æ–≥–∏ web | `docker compose logs -f web` (—Ü–≤–µ—Ç–Ω—ã–µ) | `docker compose -f docker-compose.prod.yml logs web \| jq` |
| SQL-–∑–∞–ø—Ä–æ—Å—ã | –í–∏–¥–Ω—ã –≤ –ª–æ–≥–∞—Ö web | –¢–æ–ª—å–∫–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ `log: ['query']` –≤ Prisma |
| Email-–ø–∏—Å—å–º–∞ | Ethereal preview URL –≤ –ª–æ–≥–∞—Ö | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ |
| –ü–ª–∞—Ç–µ–∂–∏ | SQL: `UPDATE users SET plan_id = ...` | –ÆKassa –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç + webhook-–ª–æ–≥–∏ |
| –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î | `psql ... localhost:5432` | `docker compose exec postgres psql -U clipmaker` |
| Redis | `redis-cli -h localhost` | `docker compose exec redis redis-cli` |
