# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ö–ª–∏–ø–ú–µ–π–∫–µ—Ä

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è](#1-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
2. [–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞](#2-–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞-—Å–µ—Ä–≤–µ—Ä–∞)
3. [–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞](#3-–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
4. [–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#4-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
5. [Docker Compose ‚Äî —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞](#5-docker-compose--—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
6. [Docker Compose ‚Äî –ø—Ä–æ–¥–∞–∫—à–Ω](#6-docker-compose--–ø—Ä–æ–¥–∞–∫—à–Ω)
7. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx –∏ SSL](#7-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-nginx-–∏-ssl)
8. [–ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#8-–º–∏–≥—Ä–∞—Ü–∏–∏-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
9. [S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ](#9-s3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
10. [–ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–æ–≤](#10-–∑–∞–ø—É—Å–∫-–≤–æ—Ä–∫–µ—Ä–æ–≤)
11. [–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏](#11-–ø—Ä–æ–≤–µ—Ä–∫–∞-—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏)
12. [–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç–∫–∞—Ç](#12-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ-–∏-–æ—Ç–∫–∞—Ç)
13. [–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ](#13-—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ-–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ)
14. [–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫](#14-—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ-–Ω–µ–ø–æ–ª–∞–¥–æ–∫)

---

## 1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

| –†–µ—Å—É—Ä—Å | –ú–∏–Ω–∏–º—É–º | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
|--------|---------|---------------|
| CPU | 4 —è–¥—Ä–∞ | 8 —è–¥–µ—Ä |
| RAM | 8 –ì–ë | 16 –ì–ë |
| SSD | 100 –ì–ë | 250 –ì–ë |
| –°–µ—Ç—å | 100 –ú–±–∏—Ç/—Å | 1 –ì–±–∏—Ç/—Å |
| –û–° | Ubuntu 22.04+ / Debian 12+ | Ubuntu 24.04 LTS |

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Ä—Å–∏—è |
|-----------|--------|
| Docker | 24.0+ |
| Docker Compose | v2.20+ |
| Node.js | 20.x LTS (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏) |
| Git | 2.40+ |
| nginx | 1.24+ (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ) |

### –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã

| –°–µ—Ä–≤–∏—Å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π |
|--------|-----------|-------------|
| Cloud.ru | AI-–æ–±—Ä–∞–±–æ—Ç–∫–∞ (STT, LLM) | –î–∞ (–¥–ª—è RU-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏) |
| S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ | –í–∏–¥–µ–æ—Ñ–∞–π–ª—ã, –∫–ª–∏–ø—ã | –î–∞ |
| –ÆKassa | –ü—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π | –î–∞ (–¥–ª—è –±–∏–ª–ª–∏–Ω–≥–∞) |
| VK API | OAuth –∏ –∞–≤—Ç–æ-–ø–æ—Å—Ç–∏–Ω–≥ | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ |

---

## 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
sudo apt update && sudo apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
sudo apt install -y ca-certificates curl gnupg lsb-release

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Docker GPG-–∫–ª—é—á–∞
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
  sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Docker
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
sudo usermod -aG docker $USER
newgrp docker
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞

```bash
sudo ufw allow 22/tcp     # SSH
sudo ufw allow 80/tcp     # HTTP
sudo ufw allow 443/tcp    # HTTPS
sudo ufw enable
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ swap (–¥–ª—è 8 –ì–ë RAM)

```bash
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

---

## 3. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone https://github.com/your-org/clipmaker.git /opt/clipmaker
cd /opt/clipmaker

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env
cp .env.example .env

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–∞–≤
chmod 600 .env
```

---

## 4. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `.env`, –∑–∞–ø–æ–ª–Ω–∏–≤ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:

```bash
# ===== –ë–ê–ó–ê –î–ê–ù–ù–´–• =====
# PostgreSQL ‚Äî —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
DATABASE_URL=postgresql://clipmaker:SECURE_PASSWORD@postgres:5432/clipmaker

# ===== REDIS =====
REDIS_URL=redis://redis:6379

# ===== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø =====
# –°–µ–∫—Ä–µ—Ç NextAuth ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ: openssl rand -hex 32
NEXTAUTH_SECRET=–≤–∞—à_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á_32_–±–∞–π—Ç–∞_hex
# URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø—Ä–æ–¥–∞–∫—à–Ω-–¥–æ–º–µ–Ω)
NEXTAUTH_URL=https://clipmaker.ru

# ===== –®–ò–§–†–û–í–ê–ù–ò–ï –¢–û–ö–ï–ù–û–í –ü–õ–ê–¢–§–û–†–ú =====
# 64 hex-—Å–∏–º–≤–æ–ª–∞ = 32 –±–∞–π—Ç–∞ AES-256
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è: openssl rand -hex 32
PLATFORM_TOKEN_SECRET=–≤–∞—à_–∫–ª—é—á_—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è_64_hex

# ===== VK OAUTH =====
VK_CLIENT_ID=12345678
VK_CLIENT_SECRET=–≤–∞—à_—Å–µ–∫—Ä–µ—Ç_vk

# ===== CLOUD.RU AI (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–ª—é—á, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è RU) =====
CLOUDRU_API_KEY=–≤–∞—à_–∫–ª—é—á_cloudru
CLOUDRU_BASE_URL=https://api.cloud.ru/v1

# ===== S3-–°–û–í–ú–ï–°–¢–ò–ú–û–ï –•–†–ê–ù–ò–õ–ò–©–ï =====
S3_ENDPOINT=https://s3.cloud.ru
S3_REGION=ru-central-1
S3_TENANT_ID=–≤–∞—à_tenant_id
S3_ACCESS_KEY=–≤–∞—à_access_key
S3_SECRET_KEY=–≤–∞—à_secret_key
S3_BUCKET=clipmaker

# ===== –ÆKASSA –ü–õ–ê–¢–ï–ñ–ò =====
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=–≤–∞—à_—Å–µ–∫—Ä–µ—Ç_yookassa

# ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï AI-–ü–†–û–í–ê–ô–î–ï–†–´ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) =====
# –ó–∞–ø–æ–ª–Ω–∏—Ç–µ, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å Global-—Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Å –æ–±—â–∏–º–∏ –∫–ª—é—á–∞–º–∏
GEMINI_API_KEY=
ANTHROPIC_API_KEY=
OPENAI_API_KEY=
OPENROUTER_API_KEY=

# ===== –†–ï–ñ–ò–ú S3 =====
# false ‚Äî presigned URLs (–ø—Ä–æ–¥–∞–∫—à–Ω)
# true ‚Äî –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ API (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
NEXT_PUBLIC_USE_S3_PROXY=false

# ===== –û–ö–†–£–ñ–ï–ù–ò–ï =====
NODE_ENV=production
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# NextAuth Secret
openssl rand -hex 32

# Platform Token Secret
openssl rand -hex 32

# –ü–∞—Ä–æ–ª—å PostgreSQL
openssl rand -base64 24
```

---

## 5. Docker Compose ‚Äî —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `docker-compose.yml` –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞:

```yaml
# docker-compose.yml (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    env_file: .env
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://clipmaker:clipmaker@postgres:5432/clipmaker
      - REDIS_URL=redis://redis:6379
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  worker-stt:
    build: .
    command: ["node", "dist/apps/worker/workers/stt.js"]
    env_file: .env
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://clipmaker:clipmaker@postgres:5432/clipmaker
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  worker-llm:
    build: .
    command: ["node", "dist/apps/worker/workers/llm-analyze.js"]
    env_file: .env
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://clipmaker:clipmaker@postgres:5432/clipmaker
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  worker-video:
    build: .
    command: ["node", "dist/apps/worker/workers/video.js"]
    env_file: .env
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://clipmaker:clipmaker@postgres:5432/clipmaker
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  worker-publish:
    build: .
    command: ["node", "dist/apps/worker/workers/publish.js"]
    env_file: .env
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://clipmaker:clipmaker@postgres:5432/clipmaker
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - miniodata:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing local/clipmaker;
      mc anonymous set download local/clipmaker;
      exit 0;
      "

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=clipmaker
      - POSTGRES_USER=clipmaker
      - POSTGRES_PASSWORD=clipmaker
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U clipmaker"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    volumes:
      - redisdata:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  pgdata:
  redisdata:
  miniodata:
```

–ó–∞–ø—É—Å–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

```bash
docker compose up -d
docker compose logs -f web
```

---

## 6. Docker Compose ‚Äî –ø—Ä–æ–¥–∞–∫—à–Ω

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `docker-compose.prod.yml`:

```yaml
# docker-compose.prod.yml
services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:3000:3000"
    env_file: .env
    environment:
      - NODE_ENV=production
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 2G

  worker-stt:
    build: .
    command: ["node", "dist/apps/worker/workers/stt.js"]
    env_file: .env
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G

  worker-llm:
    build: .
    command: ["node", "dist/apps/worker/workers/llm-analyze.js"]
    env_file: .env
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G

  worker-video:
    build: .
    command: ["node", "dist/apps/worker/workers/video-render.js"]
    env_file: .env
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "2.0"

  worker-publish:
    build: .
    command: ["node", "dist/apps/worker/workers/publish.js"]
    env_file: .env
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=clipmaker
      - POSTGRES_USER=clipmaker
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U clipmaker"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
    deploy:
      resources:
        limits:
          memory: 2G

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redisdata:/data
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

volumes:
  pgdata:
  redisdata:
```

–ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–Ω–∞:

```bash
docker compose -f docker-compose.prod.yml up -d --build
```

---

## 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx –∏ SSL

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ nginx –∏ Certbot

```bash
sudo apt install -y nginx certbot python3-certbot-nginx
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `/etc/nginx/sites-available/clipmaker`:

```nginx
# –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ HTTP –Ω–∞ HTTPS
server {
    listen 80;
    server_name clipmaker.ru www.clipmaker.ru;
    return 301 https://$server_name$request_uri;
}

# HTTPS
server {
    listen 443 ssl http2;
    server_name clipmaker.ru www.clipmaker.ru;

    # SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/clipmaker.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/clipmaker.ru/privkey.pem;

    # SSL-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    # –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ (4 –ì–ë)
    client_max_body_size 4G;

    # –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
    proxy_connect_timeout 300;
    proxy_send_timeout 300;
    proxy_read_timeout 300;
    send_timeout 300;

    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ Next.js
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
    location /_next/static {
        proxy_pass http://127.0.0.1:3000;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Health check endpoint
    location /api/health {
        proxy_pass http://127.0.0.1:3000;
        access_log off;
    }
}
```

### –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

```bash
# –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∞–π—Ç–∞
sudo ln -s /etc/nginx/sites-available/clipmaker /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo nginx -t

# –ü–æ–ª—É—á–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (—Å–Ω–∞—á–∞–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –±–µ–∑ SSL)
# 1. –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ HTTPS-–±–ª–æ–∫ –≤ nginx, –æ—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ HTTP ‚Üí proxy_pass
# 2. –ü–æ–ª—É—á–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç:
sudo certbot --nginx -d clipmaker.ru -d www.clipmaker.ru

# 3. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ HTTPS-–±–ª–æ–∫
sudo nginx -t && sudo systemctl reload nginx

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
sudo systemctl enable certbot.timer
```

---

## 8. –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
docker compose -f docker-compose.prod.yml exec web \
  npx prisma migrate deploy --schema=packages/db/prisma/schema.prisma

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
docker compose -f docker-compose.prod.yml exec web \
  npx prisma generate --schema=packages/db/prisma/schema.prisma

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π
docker compose -f docker-compose.prod.yml exec web \
  npx prisma migrate status --schema=packages/db/prisma/schema.prisma
```

---

## 9. S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

### Yandex Object Storage (–ø—Ä–æ–¥–∞–∫—à–Ω)

1. –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∫–µ—Ç –≤ Yandex Cloud Console –∏–ª–∏ Cloud.ru
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS-–ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è –±–∞–∫–µ—Ç–∞:

```json
{
  "CORSRules": [
    {
      "AllowedHeaders": ["*"],
      "AllowedMethods": ["GET", "PUT", "POST"],
      "AllowedOrigins": ["https://clipmaker.ru"],
      "MaxAgeSeconds": 3600
    }
  ]
}
```

3. –°–æ–∑–¥–∞–π—Ç–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –ø—Ä–∞–≤–∞–º–∏ `storage.editor`
4. –ü–æ–ª—É—á–∏—Ç–µ access key –∏ secret key

### MinIO (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ MinIO (–≤–∫–ª—é—á–µ–Ω –≤ docker-compose.yml –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏):

- Endpoint: `http://localhost:9000`
- –ö–æ–Ω—Å–æ–ª—å: `http://localhost:9001`
- –õ–æ–≥–∏–Ω: `minioadmin` / `minioadmin`
- –ë–∞–∫–µ—Ç `clipmaker` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `minio-init`

---

## 10. –ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–æ–≤

–í–æ—Ä–∫–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ docker-compose:

| –í–æ—Ä–∫–µ—Ä | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –†–µ—Å—É—Ä—Å–æ–µ–º–∫–æ—Å—Ç—å |
|--------|-----------|---------------|
| `worker-stt` | –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è –≤–∏–¥–µ–æ (Whisper) | –ù–∏–∑–∫–∞—è (API-–≤—ã–∑–æ–≤—ã) |
| `worker-llm` | AI-–∞–Ω–∞–ª–∏–∑ –º–æ–º–µ–Ω—Ç–æ–≤, scoring | –ù–∏–∑–∫–∞—è (API-–≤—ã–∑–æ–≤—ã) |
| `worker-video` | FFmpeg-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–ª–∏–ø–æ–≤ | –í—ã—Å–æ–∫–∞—è (CPU) |
| `worker-publish` | –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã | –ù–∏–∑–∫–∞—è (API-–≤—ã–∑–æ–≤—ã) |

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ-–≤–æ—Ä–∫–µ—Ä–æ–≤

–î–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ:

```bash
docker compose -f docker-compose.prod.yml up -d --scale worker-video=3
```

---

## 11. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose -f docker-compose.prod.yml ps

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# NAME                STATUS
# clipmaker-web       Up (healthy)
# clipmaker-worker-stt    Up
# clipmaker-worker-llm    Up
# clipmaker-worker-video  Up
# clipmaker-worker-publish Up
# clipmaker-postgres  Up (healthy)
# clipmaker-redis     Up (healthy)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker compose -f docker-compose.prod.yml logs -f web
docker compose -f docker-compose.prod.yml logs -f worker-video

# –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP-–æ—Ç–≤–µ—Ç–∞
curl -I https://clipmaker.ru

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
docker compose -f docker-compose.prod.yml exec postgres \
  psql -U clipmaker -c "SELECT count(*) FROM users;"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
docker compose -f docker-compose.prod.yml exec redis redis-cli ping
```

---

## 12. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç–∫–∞—Ç

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
cd /opt/clipmaker

# –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
git pull origin main

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
docker compose -f docker-compose.prod.yml up -d --build

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
docker compose -f docker-compose.prod.yml exec web \
  npx prisma migrate deploy --schema=packages/db/prisma/schema.prisma

# –ü—Ä–æ–≤–µ—Ä–∫–∞
docker compose -f docker-compose.prod.yml ps
```

### –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–º–∏—Ç–æ–≤
git log --oneline -10

# –û—Ç–∫–∞—Ç –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ–º–º–∏—Ç—É
git checkout <commit-hash>

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞
docker compose -f docker-compose.prod.yml up -d --build
```

---

## 13. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ PostgreSQL

–°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `/opt/clipmaker/scripts/backup.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/opt/clipmaker/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# –î–∞–º–ø PostgreSQL
docker compose -f /opt/clipmaker/docker-compose.prod.yml exec -T postgres \
  pg_dump -U clipmaker clipmaker | gzip > "$BACKUP_DIR/clipmaker_$DATE.sql.gz"

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

echo "Backup completed: clipmaker_$DATE.sql.gz"
```

–î–æ–±–∞–≤—å—Ç–µ –≤ crontab:

```bash
chmod +x /opt/clipmaker/scripts/backup.sh

# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±—ç–∫–∞–ø –≤ 3:00
crontab -e
# 0 3 * * * /opt/clipmaker/scripts/backup.sh >> /var/log/clipmaker-backup.log 2>&1
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞

```bash
gunzip < backups/clipmaker_20260101_030000.sql.gz | \
  docker compose -f docker-compose.prod.yml exec -T postgres \
  psql -U clipmaker clipmaker
```

---

## 14. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker compose -f docker-compose.prod.yml logs web --tail 50

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env
docker compose -f docker-compose.prod.yml config

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –±–µ–∑ –∫–µ—à–∞
docker compose -f docker-compose.prod.yml build --no-cache web
```

### PostgreSQL –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
docker compose -f docker-compose.prod.yml exec postgres pg_isready -U clipmaker

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
df -h

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PostgreSQL
docker compose -f docker-compose.prod.yml restart postgres
```

### Redis ‚Äî –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
docker compose -f docker-compose.prod.yml exec redis redis-cli INFO memory

# –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π
docker compose -f docker-compose.prod.yml exec redis redis-cli FLUSHDB
```

### –í–æ—Ä–∫–µ—Ä—ã –∑–∞–≤–∏—Å–ª–∏

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞
docker compose -f docker-compose.prod.yml restart worker-video

# –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—á–µ—Ä–µ–¥–µ–π BullMQ
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Bull Board –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ Redis CLI:
docker compose -f docker-compose.prod.yml exec redis \
  redis-cli LLEN bull:stt:wait
```

### FFmpeg ‚Äî –æ—à–∏–±–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ FFmpeg –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker compose -f docker-compose.prod.yml exec worker-video ffmpeg -version

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
docker compose -f docker-compose.prod.yml exec worker-video df -h /tmp
```

---

## üîÑ –û—Ç–ª–∏—á–∏—è Dev –∏ Prod —Å—Ä–µ–¥

### –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç–ª–∏—á–∏–π

| –ê—Å–ø–µ–∫—Ç | Dev (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞) | Prod (–ø—Ä–æ–¥–∞–∫—à–Ω) |
|--------|-----------------|-----------------|
| **NODE_ENV** | `development` | `production` |
| **Base URL** | `http://localhost:3000` | `NEXTAUTH_URL` (env), –Ω–∞–ø—Ä. `https://clipmaker.ru` |
| **S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** | MinIO (docker-compose, –ø–æ—Ä—Ç—ã 9000/9001) | Cloud.ru Evolution / Yandex Object Storage |
| **S3 –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º** | Proxy —á–µ—Ä–µ–∑ `/api/clips/` routes (`NEXT_PUBLIC_USE_S3_PROXY=true`) | Presigned URLs –Ω–∞–ø—Ä—è–º—É—é –∏–∑ S3 |
| **Email** | Ethereal (fake SMTP) -- preview URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ | –ù–∞—Å—Ç–æ—è—â–∏–π SMTP (`SMTP_HOST`, `SMTP_PORT` –∏ —Ç.–¥.) |
| **Email-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è** | –ê–≤—Ç–æ-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (`process.env.NODE_ENV === 'development'`) | –†–µ–∞–ª—å–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ email |
| **Worker emails** | `console.log` (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏) | SMTP –æ—Ç–ø—Ä–∞–≤–∫–∞ |
| **Cookie Secure** | `false` (HTTP localhost), `true` –≤ Codespaces | `true` (HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω) |
| **DB –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | `query` + `error` + `warn` (–≤—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã) | `error` only |
| **Log —Ñ–æ—Ä–º–∞—Ç** | `pino-pretty` (—Ü–≤–µ—Ç–Ω–æ–π, —á–∏—Ç–∞–µ–º—ã–π) | JSON (–¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –≤ Loki/ELK) |
| **Prisma Client** | `globalThis` –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (hot-reload) | –ù–æ–≤—ã–π –∏–Ω—Å—Ç–∞–Ω—Å |
| **Redis** | `redis://localhost:6379` | `REDIS_URL` (env) |
| **OAuth –ø–ª–∞—Ç—Ñ–æ—Ä–º** | Dev-mode –∑–∞–≥–ª—É—à–∫–∞ (—Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ) | –†–µ–∞–ª—å–Ω—ã–π OAuth (`VK_PUBLISH_CLIENT_ID`, `YANDEX_CLIENT_ID`) |
| **–ü–ª–∞—Ç–µ–∂–∏ (–ÆKassa)** | –ù–µ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ `YOOKASSA_SHOP_ID`/`SECRET_KEY` | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –ÆKassa |
| **Rate limiting** | –û–¥–∏–Ω–∞–∫–æ–≤–æ–µ (100 req/min, 10 uploads/hr) | –û–¥–∏–Ω–∞–∫–æ–≤–æ–µ (100 req/min, 10 uploads/hr) |

### –ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: Dev vs Prod

```bash
# ===== DEV (.env –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏) =====
NODE_ENV=development
NEXTAUTH_URL=http://localhost:3000
NEXT_PUBLIC_USE_S3_PROXY=true
DATABASE_URL=postgresql://clipmaker:clipmaker@localhost:5432/clipmaker
REDIS_URL=redis://localhost:6379
S3_ENDPOINT=http://localhost:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
# YOOKASSA_SHOP_ID=              # –Ω–µ –∑–∞–¥–∞–Ω -- –æ–ø–ª–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
# SMTP_HOST=                      # –Ω–µ –∑–∞–¥–∞–Ω -- Ethereal fallback

# ===== PROD (.env –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞) =====
NODE_ENV=production
NEXTAUTH_URL=https://clipmaker.ru
NEXT_PUBLIC_USE_S3_PROXY=false
DATABASE_URL=postgresql://clipmaker:SECURE_PASSWORD@postgres:5432/clipmaker
REDIS_URL=redis://redis:6379
S3_ENDPOINT=https://s3.cloud.ru
S3_ACCESS_KEY=–≤–∞—à_access_key
S3_SECRET_KEY=–≤–∞—à_secret_key
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=–≤–∞—à_—Å–µ–∫—Ä–µ—Ç
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=465
```

### Docker Compose: Dev vs Prod

| –ê—Å–ø–µ–∫—Ç | `docker-compose.yml` (Dev) | `docker-compose.prod.yml` (Prod) |
|--------|---------------------------|----------------------------------|
| **MinIO** | –í–∫–ª—é—á–µ–Ω (–ø–æ—Ä—Ç—ã 9000, 9001) + `minio-init` | –ù–µ –≤–∫–ª—é—á–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω–∏–π S3) |
| **–ü–æ—Ä—Ç—ã PostgreSQL** | `5432:5432` (–¥–æ—Å—Ç—É–ø–µ–Ω —Å —Ö–æ—Å—Ç–∞) | `127.0.0.1:5432:5432` (—Ç–æ–ª—å–∫–æ localhost) |
| **–ü–æ—Ä—Ç—ã Redis** | `6379:6379` (–¥–æ—Å—Ç—É–ø–µ–Ω —Å —Ö–æ—Å—Ç–∞) | `127.0.0.1:6379:6379` (—Ç–æ–ª—å–∫–æ localhost) |
| **–ü–æ—Ä—Ç—ã Web** | `3000:3000` (–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ) | `127.0.0.1:3000:3000` (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ nginx) |
| **Volumes (–∫–æ–¥)** | `.:/app` (live-reload) | –ù–µ—Ç (–æ–±—Ä–∞–∑ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–µ–ø–ª–æ–µ) |
| **Restart policy** | `unless-stopped` | `always` |
| **Resource limits** | –ù–µ –∑–∞–¥–∞–Ω—ã | –ó–∞–¥–∞–Ω—ã (web: 2G, video: 4G, pg: 2G) |
| **–ü–∞—Ä–æ–ª—å PostgreSQL** | –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (`clipmaker`) | –ò–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (`${POSTGRES_PASSWORD}`) |
| **Redis maxmemory** | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | 512 –ú–ë + `allkeys-lru` |

### –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É Dev –∏ Prod

**–ó–∞–ø—É—Å–∫ Dev-–æ–∫—Ä—É–∂–µ–Ω–∏—è:**

```bash
# –ü–æ–¥–Ω–∏–º–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã, –≤–∫–ª—é—á–∞—è MinIO
docker compose up -d
# Web –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:3000
# MinIO –∫–æ–Ω—Å–æ–ª—å –Ω–∞ http://localhost:9001
```

**–ó–∞–ø—É—Å–∫ Prod-–æ–∫—Ä—É–∂–µ–Ω–∏—è:**

```bash
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç prod-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–±–µ–∑ MinIO, —Å –ª–∏–º–∏—Ç–∞–º–∏ —Ä–µ—Å—É—Ä—Å–æ–≤)
docker compose -f docker-compose.prod.yml up -d --build
# Web –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ nginx (https://clipmaker.ru)
```

**–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ S3 —Ä–µ–∂–∏–º–∞:**

```bash
# Dev: –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ API (MinIO –Ω–µ –æ—Ç–¥–∞—ë—Ç presigned URLs –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
NEXT_PUBLIC_USE_S3_PROXY=true

# Prod: –ø—Ä—è–º—ã–µ presigned URLs –∏–∑ S3
NEXT_PUBLIC_USE_S3_PROXY=false
```
